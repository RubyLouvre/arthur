'use strict';var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function(global,factory){(typeof exports==='undefined'?'undefined':_typeof(exports))==='object'&&typeof module!=='undefined'?factory():typeof define==='function'&&define.amd?define(factory):factory();})(this,function(){var win=(typeof window==='undefined'?'undefined':_typeof(window))==='object'?window:(typeof global==='undefined'?'undefined':_typeof(global))==='object'?global:{};var inBrowser=win.location&&win.navigator;/* istanbul ignore if  */if(!win.JSON){win.JSON={stringify:function stringify(){throw'undefined json';}};}var document$1=inBrowser?win.document:{createElement:Object,createElementNS:Object,documentElement:'xx',contains:Boolean};var root=inBrowser?document$1.documentElement:{outerHTML:'x'};var versions={objectobject:7,//IE7-8
objectundefined:6,//IE6
undefinedfunction:NaN,// other modern browsers
undefinedobject:NaN//Mobile Safari 8.0.0 (iOS 8.4.0) 
};/* istanbul ignore next  */var msie=inBrowser.documentMode||versions[_typeof(document$1.all)+(typeof XMLHttpRequest==='undefined'?'undefined':_typeof(XMLHttpRequest))];var modern=msie!==msie;/*
 https://github.com/rsms/js-lru
 entry             entry             entry             entry        
 ______            ______            ______            ______       
 | head |.newer => |      |.newer => |      |.newer => | tail |      
 |  A   |          |  B   |          |  C   |          |  D   |      
 |______| <= older.|______| <= older.|______| <= older.|______|      
 
 removed  <--  <--  <--  <--  <--  <--  <--  <--  <--  <--  <--  added 
 */function Cache(maxLength){// 标识当前缓存数组的大小
this.size=0;// 标识缓存数组能达到的最大长度
this.limit=maxLength;//  head（最不常用的项），tail（最常用的项）全部初始化为undefined
this.head=this.tail=void 0;this._keymap={};}var cp=Cache.prototype;cp.put=function(key,value){var entry={key:key,value:value};this._keymap[key]=entry;if(this.tail){// 如果存在tail（缓存数组的长度不为0），将tail指向新的 entry
this.tail.newer=entry;entry.older=this.tail;}else{// 如果缓存数组的长度为0，将head指向新的entry
this.head=entry;}this.tail=entry;// 如果缓存数组达到上限，则先删除 head 指向的缓存对象
/* istanbul ignore if */if(this.size===this.limit){this.shift();}else{this.size++;}return value;};cp.shift=function(){/* istanbul ignore next */var entry=this.head;/* istanbul ignore if */if(entry){// 删除 head ，并改变指向
this.head=this.head.newer;// 同步更新 _keymap 里面的属性值
this.head.older=entry.newer=entry.older=this._keymap[entry.key]=void 0;delete this._keymap[entry.key];//#1029
// 同步更新 缓存数组的长度
this.size--;}};cp.get=function(key){var entry=this._keymap[key];// 如果查找不到含有`key`这个属性的缓存对象
if(entry===void 0)return;// 如果查找到的缓存对象已经是 tail (最近使用过的)
/* istanbul ignore if */if(entry===this.tail){return entry.value;}// HEAD--------------TAIL
//   <.older   .newer>
//  <--- add direction --
//   A  B  C  <D>  E
if(entry.newer){// 处理 newer 指向
if(entry===this.head){// 如果查找到的缓存对象是 head (最近最少使用过的)
// 则将 head 指向原 head 的 newer 所指向的缓存对象
this.head=entry.newer;}// 将所查找的缓存对象的下一级的 older 指向所查找的缓存对象的older所指向的值
// 例如：A B C D E
// 如果查找到的是D，那么将E指向C，不再指向D
entry.newer.older=entry.older;// C <-- E.
}if(entry.older){// 处理 older 指向
// 如果查找到的是D，那么C指向E，不再指向D
entry.older.newer=entry.newer;// C. --> E
}// 处理所查找到的对象的 newer 以及 older 指向
entry.newer=void 0;// D --x
// older指向之前使用过的变量，即D指向E
entry.older=this.tail;// D. --> E
if(this.tail){// 将E的newer指向D
this.tail.newer=entry;// E. <-- D
}// 改变 tail 为D 
this.tail=entry;return entry.value;};var window$1=win;function avalon(el){return new avalon.init(el);}avalon.init=function(el){this[0]=this.element=el;};avalon.fn=avalon.prototype=avalon.init.prototype;function shadowCopy(destination,source){for(var property in source){destination[property]=source[property];}return destination;}var rword=/[^, ]+/g;var rnowhite=/\S+/g;//存在非空字符
function oneObject(array,val){if(typeof array==='string'){array=array.match(rword)||[];}var result={},value=val!==void 0?val:1;for(var i=0,n=array.length;i<n;i++){result[array[i]]=value;}return result;}var op=Object.prototype;function quote(str){return avalon._quote(str);}var inspect=op.toString;var ohasOwn=op.hasOwnProperty;var ap=Array.prototype;var hasConsole=(typeof console==='undefined'?'undefined':_typeof(console))==='object';avalon.config={debug:true};function log(){if(hasConsole&&avalon.config.debug){Function.apply.call(console.log,console,arguments);}}function warn(){if(hasConsole&&avalon.config.debug){var method=console.warn||console.log;// http://qiang106.iteye.com/blog/1721425
Function.apply.call(method,console,arguments);}}function error(e,str){throw(e||Error)(str);}function noop(){}function isObject(a){return a!==null&&(typeof a==='undefined'?'undefined':_typeof(a))==='object';}function range(start,end,step){// 用于生成整数数组
step||(step=1);if(end==null){end=start||0;start=0;}var index=-1,length=Math.max(0,Math.ceil((end-start)/step)),result=new Array(length);while(++index<length){result[index]=start;start+=step;}return result;}var rhyphen=/([a-z\d])([A-Z]+)/g;function hyphen(target){//转换为连字符线风格
return target.replace(rhyphen,'$1-$2').toLowerCase();}var rcamelize=/[-_][^-_]/g;function camelize(target){//提前判断，提高getStyle等的效率
if(!target||target.indexOf('-')<0&&target.indexOf('_')<0){return target;}//转换为驼峰风格
return target.replace(rcamelize,function(match){return match.charAt(1).toUpperCase();});}var _slice=ap.slice;function slice(nodes,start,end){return _slice.call(nodes,start,end);}var rhashcode=/\d\.\d{4}/;//生成UUID http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript
function makeHashCode(prefix){/* istanbul ignore next*/prefix=prefix||'avalon';/* istanbul ignore next*/return String(Math.random()+Math.random()).replace(rhashcode,prefix);}//生成事件回调的UUID(用户通过ms-on指令)
function getLongID(fn){/* istanbul ignore next */return fn.uuid||(fn.uuid=makeHashCode('e'));}var UUID=1;//生成事件回调的UUID(用户通过avalon.bind)
function getShortID(fn){/* istanbul ignore next */return fn.uuid||(fn.uuid='_'+ ++UUID);}var rescape=/[-.*+?^${}()|[\]\/\\]/g;function escapeRegExp(target){//http://stevenlevithan.com/regex/xregexp/
//将字符串安全格式化为正则表达式的源码
return(target+'').replace(rescape,'\\$&');}var eventHooks={};var eventListeners={};var validators={};var cssHooks={};window$1.avalon=avalon;function createFragment(){/* istanbul ignore next  */return document$1.createDocumentFragment();}var rentities=/&[a-z0-9#]{2,10};/;var temp=document$1.createElement('div');shadowCopy(avalon,{evaluatorPool:new Cache(888),parsers:{number:function number(a){return a===''?'':parseFloat(a)||0;},string:function string(a){return a===null||a===void 0?'':a+'';},"boolean":function boolean(a){if(a==='')return a;return a==='true'||a==='1';}},_decode:function _decode(str){if(rentities.test(str)){temp.innerHTML=str;return temp.innerText||temp.textContent;}return str;}});avalon.Array={merge:function merge(target,other){//合并两个数组 avalon2新增
target.push.apply(target,other);},ensure:function ensure(target,item){//只有当前数组不存在此元素时只添加它
if(target.indexOf(item)===-1){return target.push(item);}},removeAt:function removeAt(target,index){//移除数组中指定位置的元素，返回布尔表示成功与否
return!!target.splice(index,1).length;},remove:function remove(target,item){//移除数组中第一个匹配传参的那个元素，返回布尔表示成功与否
var index=target.indexOf(item);if(~index)return avalon.Array.removeAt(target,index);return false;}};//============== config ============
function config(settings){for(var p in settings){var val=settings[p];if(typeof config.plugins[p]==='function'){config.plugins[p](val);}else{config[p]=val;}}return this;}var plugins={interpolate:function interpolate(array){var openTag=array[0];var closeTag=array[1];if(openTag===closeTag){throw new SyntaxError('interpolate openTag cannot equal to closeTag');}var str=openTag+'test'+closeTag;if(/[<>]/.test(str)){throw new SyntaxError('interpolate cannot contains "<" or ">"');}config.openTag=openTag;config.closeTag=closeTag;var o=escapeRegExp(openTag);var c=escapeRegExp(closeTag);config.rtext=new RegExp(o+'(.+?)'+c,'g');config.rexpr=new RegExp(o+'([\\s\\S]*)'+c);}};config.plugins=plugins;config({interpolate:['{{','}}'],debug:true});//============  config ============
shadowCopy(avalon,{shadowCopy:shadowCopy,oneObject:oneObject,inspect:inspect,ohasOwn:ohasOwn,rword:rword,scopes:{},eventHooks:eventHooks,eventListeners:eventListeners,validators:validators,cssHooks:cssHooks,log:log,noop:noop,warn:warn,error:error,config:config,modern:modern,msie:msie,root:root,document:document$1,window:window$1,inBrowser:inBrowser,isObject:isObject,range:range,slice:slice,hyphen:hyphen,camelize:camelize,escapeRegExp:escapeRegExp,quote:quote,makeHashCode:makeHashCode});describe('seed/core',function(){// jasmine.addMatchers
it('avalon',function(){expect(avalon).toA('function');var a={};expect(avalon(a)[0]).toBe(a);expect(avalon(a).element).toBe(a);});it('config',function(){try{avalon.config({interpolate:['aaa','aaa']});}catch(e){expect(e).toA('error');}try{avalon.config({interpolate:['<<','>>']});}catch(e){expect(e).toA('error');}try{avalon.config({interpolate:['aaa','>>']});}catch(e){expect(e).toA('error');}avalon.config({aaa:1});avalon.config({interpolate:['{{','}}']});expect(avalon.config.aaa).toBe(1);delete avalon.config.aaa;});it('shadowCopy',function(){var a={aa:1};var b={bb:2};var c=avalon.shadowCopy(a,b);expect(c).toBe(a);expect(c).toEqual({aa:1,bb:2});expect(avalon.shadowCopy).toBeTruthy();});it('inspect',function(){expect(inspect).toBe(Object.prototype.toString);expect(inspect.call('')).toBe('[object String]');expect(inspect.call([])).toBe('[object Array]');expect(inspect.call(1)).toBe('[object Number]');expect(inspect.call(new Date())).toBe('[object Date]');expect(inspect.call(/test/)).toBe('[object RegExp]');});it('parsers',function(){expect(avalon.parsers).toA('object');expect(avalon.parsers.number('111')).toBe(111);expect(avalon.parsers.number('')).toBe('');expect(avalon.parsers.number('ddd')).toBe(0);expect(avalon.parsers.string(111)).toBe('111');expect(avalon.parsers.string(null)).toBe('');expect(avalon.parsers.string(void 0)).toBe('');expect(avalon.parsers["boolean"]('')).toBe('');expect(avalon.parsers["boolean"]('true')).toBe(true);expect(avalon.parsers["boolean"]('1')).toBe(true);});it('ohasOwn',function(){expect(ohasOwn).toA('function');expect(ohasOwn).toBe(Object.prototype.hasOwnProperty);});it('noop',function(){expect(avalon.noop).not.toThrow();expect(avalon.noop()).toBeUndefined();});it('log',function(){expect(avalon.log(11,22)).toBeUndefined();expect(avalon.log).toA('function');spyOn(avalon,'log');avalon.log(33);expect(avalon.log).toHaveBeenCalled();});it('warn',function(){expect(avalon.warn(11,22)).toBeUndefined();expect(avalon.warn).toA('function');});it('error',function(){expect(function(){avalon.error('aaa');}).toThrowError(TypeError);expect(function fn2(){avalon.error('eee',TypeError);}).toThrowError(TypeError);});it('_decode',function(){expect(/^\s+$/.test(avalon._decode('&nbsp;'))).toBe(true);expect(avalon._decode('aaa')).toBe('aaa');});it('oneObject',function(){expect(avalon.oneObject('aa,bb,cc')).toEqual({aa:1,bb:1,cc:1});expect(avalon.oneObject('')).toEqual({});expect(avalon.oneObject([1,2,3],false)).toEqual({1:false,2:false,3:false});});it('hyphen',function(){expect(_typeof(avalon.hyphen)).toBe('function');expect(avalon.hyphen("aaaBBB")).toBe('aaa-bbb');});it('camelize',function(){expect(_typeof(avalon.camelize)).toBe('function');expect(avalon.camelize('aaa-bbb-ccc')).toBe('aaaBbbCcc');expect(avalon.camelize('aaa_bbb_ccc')).toBe('aaaBbbCcc');expect(avalon.camelize('')).toBe('');});it('makeHashCode',function(){expect(_typeof(avalon.makeHashCode)).toBe('function');expect(avalon.makeHashCode('eee')).toMatch(/eee\d+/);});it('getLongID',function(){expect(getLongID({})).toMatch(/e\d{6,}/);});it('getShortID',function(){expect(getShortID({})).toMatch(/_\d{1,3}/);});it('escapeRegExp',function(){var str='\\ ^ $ * + ? . ( ) | { } [ ]';expect(avalon.escapeRegExp(str)).toBe('\\\\ \\^ \\$ \\* \\+ \\? \\. \\( \\) \\| \\{ \\} \\[ \\]');});it('slice',function(){expect(avalon.slice([1,2,3,4],1,2)).toEqual([2]);});it('isObject',function(){expect(avalon.isObject({})).toBe(true);expect(avalon.isObject(avalon.noop)).toBe(false);});it('range',function(){expect(avalon.range(10)).toEqual([0,1,2,3,4,5,6,7,8,9]);expect(avalon.range(1,11)).toEqual([1,2,3,4,5,6,7,8,9,10]);expect(avalon.range(0,30,5)).toEqual([0,5,10,15,20,25]);expect(avalon.range(0,-10,-1)).toEqual([0,-1,-2,-3,-4,-5,-6,-7,-8,-9]);expect(avalon.range(0)).toEqual([]);});it('avalon.Array',function(){expect(avalon.Array).toA('object');expect(avalon.Array).toHaveKeys(['merge','ensure','remove','removeAt']);var aaa=[11,22];avalon.Array.merge(aaa,[33,44]);expect(aaa).toEqual([11,22,33,44]);var e1=avalon.Array.ensure(aaa,11);expect(e1).toEqual(void 0);expect(aaa).toEqual([11,22,33,44]);var e2=avalon.Array.ensure(aaa,55);expect(e2).toEqual(5);expect(aaa).toEqual([11,22,33,44,55]);avalon.Array.remove(aaa,33);expect(aaa).toEqual([11,22,44,55]);avalon.Array.remove(aaa,77);avalon.Array.removeAt(aaa,2);expect(aaa).toEqual([11,22,55]);});});describe('seed/browser',function(){it('browser',function(){expect(avalon).toHaveKeys(['window','document','root','msie','modern','inBrowser']);});});describe('测试cache文件的API',function(){describe('Cache',function(){var cache=new Cache(3);it('test',function(){expect(cache.get).toA('function');expect(cache.put).toA('function');expect(cache.shift).toA('function');var e=cache.put('aa','bb');expect(e).toBe('bb');expect(cache.limit).toBe(3);expect(cache.size).toBe(1);cache.put('eee','bb');cache.put('ddd','111');cache.get('aa');cache.put('fff','111');cache.get('aa');cache.put('999','111');expect(cache.size).toBe(3);expect(cache.get('eee')).toBe(void 0);});});});/**
 * 此模块用于修复语言的底层缺陷
 */function isNative(fn){return /\[native code\]/.test(fn);}/* istanbul ignore if*/if(!isNative('司徒正美'.trim)){var rtrim=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;String.prototype.trim=function(){return this.replace(rtrim,'');};}var hasDontEnumBug=!{'toString':null}.propertyIsEnumerable('toString');var hasProtoEnumBug=function(){}.propertyIsEnumerable('prototype');var dontEnums=['toString','toLocaleString','valueOf','hasOwnProperty','isPrototypeOf','propertyIsEnumerable','constructor'];var dontEnumsLength=dontEnums.length;/* istanbul ignore if*/if(!isNative(Object.keys)){Object.keys=function(object){//ecma262v5 15.2.3.14
var theKeys=[];var skipProto=hasProtoEnumBug&&typeof object==='function';if(typeof object==='string'||object&&object.callee){for(var i=0;i<object.length;++i){theKeys.push(String(i));}}else{for(var name in object){if(!(skipProto&&name==='prototype')&&ohasOwn.call(object,name)){theKeys.push(String(name));}}}if(hasDontEnumBug){var ctor=object.constructor,skipConstructor=ctor&&ctor.prototype===object;for(var j=0;j<dontEnumsLength;j++){var dontEnum=dontEnums[j];if(!(skipConstructor&&dontEnum==='constructor')&&ohasOwn.call(object,dontEnum)){theKeys.push(dontEnum);}}}return theKeys;};}/* istanbul ignore if*/if(!isNative(Array.isArray)){Array.isArray=function(a){return Object.prototype.toString.call(a)==='[object Array]';};}/* istanbul ignore if*/if(!isNative(isNative.bind)){/* istanbul ignore next*/Function.prototype.bind=function(scope){if(arguments.length<2&&scope===void 0)return this;var fn=this,argv=arguments;return function(){var args=[],i;for(i=1;i<argv.length;i++){args.push(argv[i]);}for(i=0;i<arguments.length;i++){args.push(arguments[i]);}return fn.apply(scope,args);};};}//https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/slice
/**
 * Shim for "fixing" IE's lack of support (IE < 9) for applying slice
 * on host objects like NamedNodeMap, NodeList, and HTMLCollection
 * (technically, since host objects have been implementation-dependent,
 * at least before ES6, IE hasn't needed to work this way).
 * Also works on strings, fixes IE < 9 to allow an explicit undefined
 * for the 2nd argument (as in Firefox), and prevents errors when
 * called on other DOM objects.
 */try{// Can't be used with DOM elements in IE < 9
_slice.call(avalon.document.documentElement);}catch(e){// Fails in IE < 9
// This will work for genuine arrays, array-like objects,
// NamedNodeMap (attributes, entities, notations),
// NodeList (e.g., getElementsByTagName), HTMLCollection (e.g., childNodes),
// and will not fail on other DOM objects (as do DOM elements in IE < 9)
/* istanbul ignore next*/ap.slice=function(begin,end){// IE < 9 gets unhappy with an undefined end argument
end=typeof end!=='undefined'?end:this.length;// For native Array objects, we use the native slice function
if(Array.isArray(this)){return _slice.call(this,begin,end);}// For array like object we handle it ourselves.
var i,cloned=[],size,len=this.length;// Handle negative value for "begin"
var start=begin||0;start=start>=0?start:len+start;// Handle negative value for "end"
var upTo=end?end:len;if(end<0){upTo=len+end;}// Actual expected size of the slice
size=upTo-start;if(size>0){cloned=new Array(size);if(this.charAt){for(i=0;i<size;i++){cloned[i]=this.charAt(start+i);}}else{for(i=0;i<size;i++){cloned[i]=this[start+i];}}}return cloned;};}/* istanbul ignore next*/function iterator(vars,body,ret){var fun='for(var '+vars+'i=0,n = this.length; i < n; i++){'+body.replace('_','((i in this) && fn.call(scope,this[i],i,this))')+'}'+ret;/* jshint ignore:start */return Function('fn,scope',fun);/* jshint ignore:end */}/* istanbul ignore if*/if(!isNative(ap.map)){avalon.shadowCopy(ap,{//定位操作，返回数组中第一个等于给定参数的元素的索引值。
indexOf:function indexOf(item,index){var n=this.length,i=~~index;if(i<0)i+=n;for(;i<n;i++){if(this[i]===item)return i;}return-1;},//定位操作，同上，不过是从后遍历。
lastIndexOf:function lastIndexOf(item,index){var n=this.length,i=index==null?n-1:index;if(i<0)i=Math.max(0,n+i);for(;i>=0;i--){if(this[i]===item)return i;}return-1;},//迭代操作，将数组的元素挨个儿传入一个函数中执行。Prototype.js的对应名字为each。
forEach:iterator('','_',''),//迭代类 在数组中的每个项上运行一个函数，如果此函数的值为真，则此元素作为新数组的元素收集起来，并返回新数组
filter:iterator('r=[],j=0,','if(_)r[j++]=this[i]','return r'),//收集操作，将数组的元素挨个儿传入一个函数中执行，然后把它们的返回值组成一个新数组返回。Prototype.js的对应名字为collect。
map:iterator('r=[],','r[i]=_','return r'),//只要数组中有一个元素满足条件（放进给定函数返回true），那么它就返回true。Prototype.js的对应名字为any。
some:iterator('','if(_)return true','return false'),//只有数组中的元素都满足条件（放进给定函数返回true），它才返回true。Prototype.js的对应名字为all。
every:iterator('','if(!_)return false','return true')});}//这里放置存在异议的方法
var compaceQuote=function(){//https://github.com/bestiejs/json3/blob/master/lib/json3.js
var Escapes={92:"\\\\",34:'\\"',8:"\\b",12:"\\f",10:"\\n",13:"\\r",9:"\\t"};var leadingZeroes='000000';var toPaddedString=function toPaddedString(width,value){return(leadingZeroes+(value||0)).slice(-width);};var unicodePrefix='\\u00';var escapeChar=function escapeChar(character){var charCode=character.charCodeAt(0),escaped=Escapes[charCode];if(escaped){return escaped;}return unicodePrefix+toPaddedString(2,charCode.toString(16));};var reEscape=/[\x00-\x1f\x22\x5c]/g;return function(value){/* istanbul ignore next */reEscape.lastIndex=0;/* istanbul ignore next */return'"'+(reEscape.test(value)?String(value).replace(reEscape,escapeChar):value)+'"';};}();try{avalon._quote=window$1.JSON.stringify;}catch(e){/* istanbul ignore next  */avalon._quote=compaceQuote;}var class2type={};'Boolean Number String Function Array Date RegExp Object Error'.replace(avalon.rword,function(name){class2type['[object '+name+']']=name.toLowerCase();});avalon.type=function(obj){//取得目标的类型
if(obj==null){return String(obj);}// 早期的webkit内核浏览器实现了已废弃的ecma262v4标准，可以将正则字面量当作函数使用，因此typeof在判定正则时会返回function
return(typeof obj==='undefined'?'undefined':_typeof(obj))==='object'||typeof obj==='function'?class2type[inspect.call(obj)]||'object':typeof obj==='undefined'?'undefined':_typeof(obj);};var rfunction=/^\s*\bfunction\b/;avalon.isFunction=/* istanbul ignore if */(typeof alert==='undefined'?'undefined':_typeof(alert))==='object'?function(fn){/* istanbul ignore next */try{/* istanbul ignore next */return rfunction.test(fn+'');}catch(e){/* istanbul ignore next */return false;}}:function(fn){return inspect.call(fn)==='[object Function]';};// 利用IE678 window == document为true,document == window竟然为false的神奇特性
// 标准浏览器及IE9，IE10等使用 正则检测
/* istanbul ignore next */function isWindowCompact(obj){if(!obj){return false;}return obj==obj.document&&obj.document!=obj;//jshint ignore:line
}var rwindow=/^\[object (?:Window|DOMWindow|global)\]$/;function isWindowModern(obj){return rwindow.test(inspect.call(obj));}avalon.isWindow=isWindowModern(avalon.window)?isWindowModern:isWindowCompact;var enu;var enumerateBUG;for(enu in avalon({})){break;}enumerateBUG=enu!=='0';//IE6下为true, 其他为false
/*判定是否是一个朴素的javascript对象（Object），不是DOM对象，不是BOM对象，不是自定义类的实例*//* istanbul ignore next */function isPlainObjectCompact(obj,key){if(!obj||avalon.type(obj)!=='object'||obj.nodeType||avalon.isWindow(obj)){return false;}try{//IE内置对象没有constructor
if(obj.constructor&&!ohasOwn.call(obj,'constructor')&&!ohasOwn.call(obj.constructor.prototype,'isPrototypeOf')){return false;}}catch(e){//IE8 9会在这里抛错
return false;}if(enumerateBUG){for(key in obj){return ohasOwn.call(obj,key);}}for(key in obj){}return key===void 0||ohasOwn.call(obj,key);}/* istanbul ignore next */function isPlainObjectModern(obj){// 简单的 typeof obj === 'object'检测，会致使用isPlainObject(window)在opera下通不过
return inspect.call(obj)==='[object Object]'&&Object.getPrototypeOf(obj)===Object.prototype;}/* istanbul ignore next */avalon.isPlainObject=/\[native code\]/.test(Object.getPrototypeOf)?isPlainObjectModern:isPlainObjectCompact;//与jQuery.extend方法，可用于浅拷贝，深拷贝
/* istanbul ignore next */avalon.mix=avalon.fn.mix=function(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=false;// 如果第一个参数为布尔,判定是否深拷贝
if(typeof target==='boolean'){deep=target;target=arguments[1]||{};i++;}//当参数为其他简单类型 ,改为空对象
if((typeof target==='undefined'?'undefined':_typeof(target))!=='object'&&!avalon.isFunction(target)){target={};}//如果只有一个参数，那么新成员添加于mix所在的对象上
if(i===length){target=this;i--;}for(;i<length;i++){//只处理非空参数
if((options=arguments[i])!=null){var noCloneArrayMethod=Array.isArray(options);for(name in options){if(noCloneArrayMethod&&!options.hasOwnProperty(name)){continue;}try{src=target[name];copy=options[name];//当options为VBS对象时报错
}catch(e){continue;}// 防止环引用
if(target===copy){continue;}if(deep&&copy&&(avalon.isPlainObject(copy)||(copyIsArray=Array.isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&Array.isArray(src)?src:[];}else{clone=src&&avalon.isPlainObject(src)?src:{};}target[name]=avalon.mix(deep,clone,copy);}else if(copy!==void 0){target[name]=copy;}}}}return target;};var rarraylike=/(Array|List|Collection|Map|Arguments)\]$/;/*判定是否类数组，如节点集合，纯数组，arguments与拥有非负整数的length属性的纯JS对象*//* istanbul ignore next */function isArrayLike(obj){if(!obj)return false;var n=obj.length;if(n===n>>>0){//检测length属性是否为非负整数
var type=inspect.call(obj).slice(8,-1);if(rarraylike.test(type))return false;if(type==='Array')return true;try{if({}.propertyIsEnumerable.call(obj,'length')===false){//如果是原生对象
return rfunction.test(obj.item||obj.callee);}return true;}catch(e){//IE的NodeList直接抛错
return!obj.window;//IE6-8 window
}}return false;}avalon.each=function(obj,fn){if(obj){//排除null, undefined
var i=0;if(isArrayLike(obj)){for(var n=obj.length;i<n;i++){if(fn(i,obj[i])===false)break;}}else{for(i in obj){if(obj.hasOwnProperty(i)&&fn(i,obj[i])===false){break;}}}}};/*
 new function welcome() {
 var welcomeIntro = ["%cavalon.js %c" + avalon.version + " %cin debug mode, %cmore...", "color: rgb(114, 157, 52); font-weight: normal;", "color: rgb(85, 85, 85); font-weight: normal;", "color: rgb(85, 85, 85); font-weight: normal;", "color: rgb(82, 140, 224); font-weight: normal; text-decoration: underline;"];
 var welcomeMessage = "You're running avalon in debug mode - messages will be printed to the console to help you fix problems and optimise your application.\n\n" +
 'To disable debug mode, add this line at the start of your app:\n\n  avalon.config({debug: false});\n\n' +
 'Debug mode also automatically shut down amicably when your app is minified.\n\n' +
 "Get help and support:\n  https://segmentfault.com/t/avalon\n  http://avalonjs.coding.me/\n  http://www.baidu-x.com/?q=avalonjs\n  http://www.avalon.org.cn/\n\nFound a bug? Raise an issue:\n  https://github.com/RubyLouvre/avalon/issues\n\n";
 if (typeof console === 'object') {
 var con = console
 var method = con.groupCollapsed || con.log
 Function.apply.call(method, con, welcomeIntro)
 con.log(welcomeMessage)
 if (method !== console.log) {
 con.groupEnd(welcomeIntro);
 }
 }
 }
 */describe('seed/lang',function(){it('quote',function(){expect(avalon.quote).toA('function');expect(avalon.quote('1')).toBe('"1"');expect(avalon.quote('foo\nbar\r\nbaz')).toBe('"foo\\nbar\\r\\nbaz"');expect(compaceQuote('1')).toBe('"1"');expect(compaceQuote('foo\nbar\r\nbaz')).toBe('"foo\\nbar\\r\\nbaz"');expect(compaceQuote('\x01')).toBe('"\\u0001"');});it('type',function(){var fn=avalon.type;expect(fn(/e\d+/)).toEqual('regexp');expect(fn('sss')).toEqual('string');expect(fn(111)).toEqual('number');expect(fn(new Error())).toEqual('error');expect(fn(Date)).toEqual('function');expect(fn(new Date())).toEqual('date');expect(fn({})).toEqual('object');expect(fn(null)).toEqual('null');expect(fn(void 0)).toEqual('undefined');});it('isFunction',function(){expect(avalon.isFunction(avalon.noop)).toEqual(true);});it('isWindow',function(){expect(avalon.isWindow(avalon.document)).toEqual(false);expect(avalon.isWindow(window)).toBeTruthy();});it('isPlainObjectCompact',function(){var pass,doc,parentObj,childObj,deep,fn=function fn(){};// The use case that we want to match
expect(isPlainObjectCompact({})).toBeTruthy();expect(isPlainObjectCompact(new window.Object())).toBeTruthy();expect(isPlainObjectCompact({constructor:fn})).toBeTruthy();expect(isPlainObjectCompact({constructor:"foo"})).toBeTruthy();parentObj={};// Not objects shouldn't be matched
expect(!isPlainObjectCompact("")).toBeTruthy();expect(!isPlainObjectCompact(0)&&!isPlainObjectCompact(1)).toBeTruthy();expect(!isPlainObjectCompact(true)&&!isPlainObjectCompact(false)).toBeTruthy();expect(!isPlainObjectCompact(null)).toBeTruthy();expect(!isPlainObjectCompact(undefined)).toBeTruthy();// Arrays shouldn't be matched
expect(!isPlainObjectCompact([])).toBeTruthy();// Instantiated objects shouldn't be matched
expect(!isPlainObjectCompact(new Date())).toBeTruthy();// Functions shouldn't be matched
expect(!isPlainObjectCompact(fn)).toBeTruthy();// Again, instantiated objects shouldn't be matched
expect(!isPlainObjectCompact(new fn())).toBeTruthy();// Makes the function a little more realistic
// (and harder to detect, incidentally)
fn.prototype["someMethod"]=function(){};// Again, instantiated objects shouldn't be matched
expect(!isPlainObjectCompact(new fn())).toBeTruthy();// Instantiated objects with primitive constructors shouldn't be matched
fn.prototype.constructor="foo";expect(!isPlainObjectCompact(new fn())).toBeTruthy();// Deep object
deep={"foo":{"baz":true},"foo2":document};expect(isPlainObjectCompact(deep)).toBeTruthy();// DOM Element
expect(!isPlainObjectCompact(document.createElement("div"))).toBeTruthy();// Window
expect(!isPlainObjectCompact(window)).toBeTruthy();});it('isPlainObject',function(){expect(avalon.isPlainObject({})).toBeTruthy();expect(avalon.isPlainObject(new Object())).toBeTruthy();});it('mix',function(){expect(avalon.mix).toA('function');expect(avalon.mix('aaa',{a:1})).toEqual({a:1});var empty,optionsWithLength,optionsWithDate,myKlass,customObject,optionsWithCustomObject,MyNumber,ret,nullUndef,target,recursive,obj,defaults,defaultsCopy,options1,options1Copy,options2,options2Copy,merged2,settings={"xnumber1":5,"xnumber2":7,"xstring1":"peter","xstring2":"pan"},options={"xnumber2":1,"xstring2":"x","xxx":"newstring"},optionsCopy={"xnumber2":1,"xstring2":"x","xxx":"newstring"},merged={"xnumber1":5,"xnumber2":1,"xstring1":"peter","xstring2":"x","xxx":"newstring"},deep1={"foo":{"bar":true}},deep2={"foo":{"baz":true},"foo2":document},deep2copy={"foo":{"baz":true},"foo2":document},deepmerged={"foo":{"bar":true,"baz":true},"foo2":document},arr=[1,2,3],nestedarray={"arr":arr};avalon.mix(settings,options);expect(settings).toEqual(merged);expect(options).toEqual(optionsCopy);avalon.mix(settings,null,options);expect(settings).toEqual(merged);expect(options).toEqual(optionsCopy);avalon.mix(true,deep1,deep2);expect(deep1["foo"]).toEqual(deepmerged["foo"]);expect(deep2["foo"]).toEqual(deep2copy["foo"]);expect(deep1["foo2"]).toBe(document);expect(avalon.mix(true,{},nestedarray)["arr"]).not.toBe(arr);var circulate={};var child={a:circulate};expect(avalon.mix(circulate,child,{a:1})).toEqual({a:1});avalon.mix({testA:1});//将数据加在它上面
expect(avalon.testA).toEqual(1);delete avalon.testA;// ???
//        var testA = {testA: 1}
//        avalon.mix(testA, 'string') //当参数为其他简单类型 
//        expect(testA ).toEqual( {testA: 1} ) 
// deep copy with array, followed by object
var result,initial={// This will make "copyIsArray" true
array:[1,2,3,4],// If "copyIsArray" doesn't get reset to false, the check
// will evaluate true and enter the array copy block
// instead of the object copy block. Since the ternary in the
// "copyIsArray" block will evaluate to false
// (check if operating on an array with ), this will be
// replaced by an empty array.
object:{}};result=avalon.mix(true,{},initial);//IE8  会完蛋?
expect(result.array).toEqual(initial.array);expect(!Array.isArray(result.object)).toBe(true);});it('each',function(){expect(avalon.each).toA('function');var array=[];avalon.each({a:1,b:2},function(k,v){array.push(k,v);});expect(array.join(',')).toBe('a,1,b,2');var array2=[];avalon.each(['c','d'],function(k,v){array2.push(k,v);});expect(array2.join(',')).toBe('0,c,1,d');var seen=[];avalon.each([1,2,3],function(k,v){seen.push(v);if(k===1){return false;}});expect(seen).toEqual([1,2]);var seen2=[];avalon.each({x:11,y:22,z:33},function(k,v){if(k==='z'){return false;}seen2.push(v);});expect(seen2).toEqual([11,22]);});it('isArrayLike',function(){expect(isArrayLike({0:11,1:11,length:2})).toBeTruthy();expect(isArrayLike(arguments)).toBeTruthy();expect(!isArrayLike(null)).toBeTruthy();expect(!isArrayLike(undefined)).toBeTruthy();expect(!isArrayLike(true)).toBeTruthy();expect(!isArrayLike(false)).toBeTruthy();expect(!isArrayLike(function(){})).toBeTruthy();expect(!isArrayLike('')).toBeTruthy();expect(!isArrayLike('abc')).toBeTruthy();});});function toFixedFix(n,prec){var k=Math.pow(10,prec);return''+(Math.round(n*k)/k).toFixed(prec);}function numberFilter(number,decimals,point,thousands){//https://github.com/txgruppi/number_format
//form http://phpjs.org/functions/number_format/
//number 必需，要格式化的数字
//decimals 可选，规定多少个小数位。
//point 可选，规定用作小数点的字符串（默认为 . ）。
//thousands 可选，规定用作千位分隔符的字符串（默认为 , ），如果设置了该参数，那么所有其他参数都是必需的。
number=(number+'').replace(/[^0-9+\-Ee.]/g,'');var n=!isFinite(+number)?0:+number,prec=!isFinite(+decimals)?3:Math.abs(decimals),sep=thousands||",",dec=point||".",s='';// Fix for IE parseFloat(0.55).toFixed(0) = 0;
s=(prec?toFixedFix(n,prec):''+Math.round(n)).split('.');if(s[0].length>3){s[0]=s[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,sep);}/** //好像没有用
       var s1 = s[1] || ''
      
        if (s1.length < prec) {
                s1 += new Array(prec - s[1].length + 1).join('0')
                s[1] = s1
        }
        **/return s.join(dec);}var rscripts=/<script[^>]*>([\S\s]*?)<\/script\s*>/gim;var ron=/\s+(on[^=\s]+)(?:=("[^"]*"|'[^']*'|[^\s>]+))?/g;var ropen=/<\w+\b(?:(["'])[^"]*?(\1)|[^>])*>/ig;var rsanitize={a:/\b(href)\=("javascript[^"]*"|'javascript[^']*')/ig,img:/\b(src)\=("javascript[^"]*"|'javascript[^']*')/ig,form:/\b(action)\=("javascript[^"]*"|'javascript[^']*')/ig};//https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet
//    <a href="javasc&NewLine;ript&colon;alert('XSS')">chrome</a> 
//    <a href="data:text/html;base64, PGltZyBzcmM9eCBvbmVycm9yPWFsZXJ0KDEpPg==">chrome</a>
//    <a href="jav	ascript:alert('XSS');">IE67chrome</a>
//    <a href="jav&#x09;ascript:alert('XSS');">IE67chrome</a>
//    <a href="jav&#x0A;ascript:alert('XSS');">IE67chrome</a>
function sanitizeFilter(str){return str.replace(rscripts,"").replace(ropen,function(a,b){var match=a.toLowerCase().match(/<(\w+)\s/);if(match){//处理a标签的href属性，img标签的src属性，form标签的action属性
var reg=rsanitize[match[1]];if(reg){a=a.replace(reg,function(s,name,value){var quote=value.charAt(0);return name+"="+quote+"javascript:void(0)"+quote;// jshint ignore:line
});}}return a.replace(ron," ").replace(/\s+/g," ");//移除onXXX事件
});}/*
 'yyyy': 4 digit representation of year (e.g. AD 1 => 0001, AD 2010 => 2010)
 'yy': 2 digit representation of year, padded (00-99). (e.g. AD 2001 => 01, AD 2010 => 10)
 'y': 1 digit representation of year, e.g. (AD 1 => 1, AD 199 => 199)
 'MMMM': Month in year (January-December)
 'MMM': Month in year (Jan-Dec)
 'MM': Month in year, padded (01-12)
 'M': Month in year (1-12)
 'dd': Day in month, padded (01-31)
 'd': Day in month (1-31)
 'EEEE': Day in Week,(Sunday-Saturday)
 'EEE': Day in Week, (Sun-Sat)
 'HH': Hour in day, padded (00-23)
 'H': Hour in day (0-23)
 'hh': Hour in am/pm, padded (01-12)
 'h': Hour in am/pm, (1-12)
 'mm': Minute in hour, padded (00-59)
 'm': Minute in hour (0-59)
 'ss': Second in minute, padded (00-59)
 's': Second in minute (0-59)
 'a': am/pm marker
 'Z': 4 digit (+sign) representation of the timezone offset (-1200-+1200)
 format string can also be one of the following predefined localizable formats:
 
 'medium': equivalent to 'MMM d, y h:mm:ss a' for en_US locale (e.g. Sep 3, 2010 12:05:08 pm)
 'short': equivalent to 'M/d/yy h:mm a' for en_US locale (e.g. 9/3/10 12:05 pm)
 'fullDate': equivalent to 'EEEE, MMMM d,y' for en_US locale (e.g. Friday, September 3, 2010)
 'longDate': equivalent to 'MMMM d, y' for en_US locale (e.g. September 3, 2010
 'mediumDate': equivalent to 'MMM d, y' for en_US locale (e.g. Sep 3, 2010)
 'shortDate': equivalent to 'M/d/yy' for en_US locale (e.g. 9/3/10)
 'mediumTime': equivalent to 'h:mm:ss a' for en_US locale (e.g. 12:05:08 pm)
 'shortTime': equivalent to 'h:mm a' for en_US locale (e.g. 12:05 pm)
 */function toInt(str){return parseInt(str,10)||0;}function padNumber(num,digits,trim){var neg='';/* istanbul ignore if*/if(num<0){neg='-';num=-num;}num=''+num;while(num.length<digits){num='0'+num;}if(trim)num=num.substr(num.length-digits);return neg+num;}function dateGetter(name,size,offset,trim){return function(date){var value=date["get"+name]();if(offset>0||value>-offset)value+=offset;if(value===0&&offset===-12){/* istanbul ignore next*/value=12;}return padNumber(value,size,trim);};}function dateStrGetter(name,shortForm){return function(date,formats){var value=date["get"+name]();var get=(shortForm?"SHORT"+name:name).toUpperCase();return formats[get][value];};}function timeZoneGetter(date){var zone=-1*date.getTimezoneOffset();var paddedZone=zone>=0?"+":"";paddedZone+=padNumber(Math[zone>0?"floor":"ceil"](zone/60),2)+padNumber(Math.abs(zone%60),2);return paddedZone;}//取得上午下午
function ampmGetter(date,formats){return date.getHours()<12?formats.AMPMS[0]:formats.AMPMS[1];}var DATE_FORMATS={yyyy:dateGetter("FullYear",4),yy:dateGetter("FullYear",2,0,true),y:dateGetter("FullYear",1),MMMM:dateStrGetter("Month"),MMM:dateStrGetter("Month",true),MM:dateGetter("Month",2,1),M:dateGetter("Month",1,1),dd:dateGetter("Date",2),d:dateGetter("Date",1),HH:dateGetter("Hours",2),H:dateGetter("Hours",1),hh:dateGetter("Hours",2,-12),h:dateGetter("Hours",1,-12),mm:dateGetter("Minutes",2),m:dateGetter("Minutes",1),ss:dateGetter("Seconds",2),s:dateGetter("Seconds",1),sss:dateGetter("Milliseconds",3),EEEE:dateStrGetter("Day"),EEE:dateStrGetter("Day",true),a:ampmGetter,Z:timeZoneGetter};var rdateFormat=/((?:[^yMdHhmsaZE']+)|(?:'(?:[^']|'')*')|(?:E+|y+|M+|d+|H+|h+|m+|s+|a|Z))(.*)/;var raspnetjson=/^\/Date\((\d+)\)\/$/;function dateFilter(date,format){var locate=dateFilter.locate,text="",parts=[],fn,match;format=format||"mediumDate";format=locate[format]||format;if(typeof date==="string"){if(/^\d+$/.test(date)){date=toInt(date);}else if(raspnetjson.test(date)){date=+RegExp.$1;}else{var trimDate=date.trim();var dateArray=[0,0,0,0,0,0,0];var oDate=new Date(0);//取得年月日
trimDate=trimDate.replace(/^(\d+)\D(\d+)\D(\d+)/,function(_,a,b,c){var array=c.length===4?[c,a,b]:[a,b,c];dateArray[0]=toInt(array[0]);//年
dateArray[1]=toInt(array[1])-1;//月
dateArray[2]=toInt(array[2]);//日
return"";});var dateSetter=oDate.setFullYear;var timeSetter=oDate.setHours;trimDate=trimDate.replace(/[T\s](\d+):(\d+):?(\d+)?\.?(\d)?/,function(_,a,b,c,d){dateArray[3]=toInt(a);//小时
dateArray[4]=toInt(b);//分钟
dateArray[5]=toInt(c);//秒
if(d){//毫秒
dateArray[6]=Math.round(parseFloat("0."+d)*1000);}return"";});var tzHour=0;var tzMin=0;trimDate=trimDate.replace(/Z|([+-])(\d\d):?(\d\d)/,function(z,symbol,c,d){dateSetter=oDate.setUTCFullYear;timeSetter=oDate.setUTCHours;if(symbol){tzHour=toInt(symbol+c);tzMin=toInt(symbol+d);}return'';});dateArray[3]-=tzHour;dateArray[4]-=tzMin;dateSetter.apply(oDate,dateArray.slice(0,3));timeSetter.apply(oDate,dateArray.slice(3));date=oDate;}}if(typeof date==='number'){date=new Date(date);}while(format){match=rdateFormat.exec(format);/* istanbul ignore else */if(match){parts=parts.concat(match.slice(1));format=parts.pop();}else{parts.push(format);format=null;}}parts.forEach(function(value){fn=DATE_FORMATS[value];text+=fn?fn(date,locate):value.replace(/(^'|'$)/g,"").replace(/''/g,"'");});return text;}var locate={AMPMS:{0:'上午',1:'下午'},DAY:{0:'星期日',1:'星期一',2:'星期二',3:'星期三',4:'星期四',5:'星期五',6:'星期六'},MONTH:{0:'1月',1:'2月',2:'3月',3:'4月',4:'5月',5:'6月',6:'7月',7:'8月',8:'9月',9:'10月',10:'11月',11:'12月'},SHORTDAY:{'0':'周日','1':'周一','2':'周二','3':'周三','4':'周四','5':'周五','6':'周六'},fullDate:'y年M月d日EEEE',longDate:'y年M月d日',medium:'yyyy-M-d H:mm:ss',mediumDate:'yyyy-M-d',mediumTime:'H:mm:ss','short':'yy-M-d ah:mm',shortDate:'yy-M-d',shortTime:'ah:mm'};locate.SHORTMONTH=locate.MONTH;dateFilter.locate=locate;/*
https://github.com/hufyhang/orderBy/blob/master/index.js
*/function orderBy(array,by,decend){var type=avalon.type(array);if(type!=='array'&&type!=='object')throw'orderBy只能处理对象或数组';var criteria=typeof by=='string'?function(el){return el&&el[by];}:typeof by==='function'?by:function(el){return el;};var mapping={};var temp=[];var index=0;for(var key in array){if(array.hasOwnProperty(key)){var val=array[key];var k=criteria(val,key);if(k in mapping){mapping[k].push(key);}else{mapping[k]=[key];}temp.push(k);}}temp.sort();if(decend<0){temp.reverse();}var _array=type==='array';var target=_array?[]:{};return recovery(target,temp,function(k){var key=mapping[k].shift();if(_array){target.push(array[key]);}else{target[key]=array[key];}});}function filterBy(array,search){var type=avalon.type(array);if(type!=='array'&&type!=='object')throw'filterBy只能处理对象或数组';var args=avalon.slice(arguments,2);var stype=avalon.type(search);if(stype==='function'){var criteria=search;}else if(stype==='string'||stype==='number'){if(search===''){return array;}else{var reg=new RegExp(avalon.escapeRegExp(search),'i');criteria=function criteria(el){return reg.test(el);};}}else{return array;}array=convertArray(array).filter(function(el,i){return!!criteria.apply(el,[el.value,i].concat(args));});var isArray=type==='array';var target=isArray?[]:{};return recovery(target,array,function(el){if(isArray){target.push(el.value);}else{target[el.key]=el.value;}});}function selectBy(data,array,defaults){if(avalon.isObject(data)&&!Array.isArray(data)){var target=[];return recovery(target,array,function(name){target.push(data.hasOwnProperty(name)?data[name]:defaults?defaults[name]:'');});}else{return data;}}function limitBy(input,limit,begin){var type=avalon.type(input);if(type!=='array'&&type!=='object')throw'limitBy只能处理对象或数组';//必须是数值
if(typeof limit!=='number'){return input;}//不能为NaN
if(limit!==limit){return input;}//将目标转换为数组
if(type==='object'){input=convertArray(input);}var n=input.length;limit=Math.floor(Math.min(n,limit));begin=typeof begin==='number'?begin:0;if(begin<0){begin=Math.max(0,n+begin);}var data=[];for(var i=begin;i<n;i++){if(data.length===limit){break;}data.push(input[i]);}var isArray=type==='array';if(isArray){return data;}var target={};return recovery(target,data,function(el){target[el.key]=el.value;});}function recovery(ret,array,callback){for(var i=0,n=array.length;i<n;i++){callback(array[i]);}return ret;}//Chrome谷歌浏览器中js代码Array.sort排序的bug乱序解决办法
//http://www.cnblogs.com/yzeng/p/3949182.html
function convertArray(array){var ret=[],i=0;for(var key in array){if(array.hasOwnProperty(key)){ret[i]={oldIndex:i,value:array[key],key:key};i++;}}return ret;}var eventFilters={stop:function stop(e){e.stopPropagation();return e;},prevent:function prevent(e){e.preventDefault();return e;}};var keys={esc:27,tab:9,enter:13,space:32,del:46,up:38,left:37,right:39,down:40};for(var name in keys){(function(filter,key){eventFilters[filter]=function(e){if(e.which!==key){e.$return=true;}return e;};})(name,keys[name]);}//https://github.com/teppeis/htmlspecialchars
function escapeFilter(str){if(str==null)return'';return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}var filters=avalon.filters={};avalon.escapeHtml=escapeFilter;avalon.mix(filters,{uppercase:function uppercase(str){return String(str).toUpperCase();},lowercase:function lowercase(str){return String(str).toLowerCase();},truncate:function truncate(str,length,end){//length，新字符串长度，truncation，新字符串的结尾的字段,返回新字符串
if(!str){return'';}str=String(str);if(isNaN(length)){length=30;}end=typeof end==="string"?end:"...";return str.length>length?str.slice(0,length-end.length)+end:/* istanbul ignore else*/str;},camelize:avalon.camelize,date:dateFilter,escape:escapeFilter,sanitize:sanitizeFilter,number:numberFilter,currency:function currency(amount,symbol,fractionSize){return(symbol||'\xA5')+numberFilter(amount,isFinite(fractionSize)?/* istanbul ignore else*/fractionSize:2);}},{filterBy:filterBy,orderBy:orderBy,selectBy:selectBy,limitBy:limitBy},eventFilters);describe('filters',function(){describe('uppercase',function(){var fn=avalon.filters.uppercase;it('test',function(){expect(fn('aaa')).toBe('AAA');});});describe('lowercase',function(){var fn=avalon.filters.lowercase;it('test',function(){expect(fn('AAA')).toBe('aaa');});});describe('escape',function(){var fn=avalon.filters.escape;it('escapes "&" to "&amp;"',function(){expect(fn('&')).toBe('&amp;');});it('escapes null to 0',function(){expect(fn(null)).toBe('');});it('escapes "<" to "&lt;"',function(){expect(fn('<')).toBe('&lt;');});it('escapes ">" to "&gt;"',function(){expect(fn('>')).toBe('&gt;');});it('escapes \'"\' to "&quot;"',function(){expect(fn('"')).toBe('&quot;');});it('escapes "\'" to "&#39;"',function(){expect(fn("'")).toBe('&#39;');});it('escapes all special chars',function(){expect(fn("<&<&")).toBe('&lt;&amp;&lt;&amp;');});it('returns an empty string for null',function(){expect(fn(null)).toBe('');});it('returns an empty string for undefined',function(){expect(fn(null)).toBe('');});it('stringify non-string value',function(){expect(fn(1)).toBe('1');});it('returns "false" for false',function(){expect(fn(false)).toBe('false');});});describe('sanitize',function(){it('test',function(){var str='<a href="javascript:fix">SSS</a><img onclick=333 src=http://tp2.sinaimg.cn/1823438905/180/40054009869/1/><p onfocus="aaa" ontap="ddd" title=eee onkeypress=eee>onmousewheel=eee<span onmouseup="ddd">DDD</span></p><script>alert(1)<\/script>222222';var ret=avalon.filters.sanitize(str);expect(ret.indexOf('fix')).toBe(-1);expect(ret.indexOf('onclick')).toBe(-1);expect(ret.indexOf('ontap')).toBe(-1);expect(ret.indexOf('onkeypress')).toBe(-1);expect(ret.indexOf('onfocus')).toBe(-1);expect(ret.indexOf('onmouseup')).toBe(-1);expect(ret.indexOf('<script')).toBe(-1);expect(ret.indexOf('onmousewheel')).not.toBe(-1);});});describe('camelize',function(){var fn=avalon.filters.camelize;it('test',function(){expect(fn('aa-bb')).toBe('aaBb');expect(fn('aa_cb')).toBe('aaCb');});});describe('number',function(){var fn=avalon.filters.number;it('test',function(){expect(fn(1234.56,0)).toBe('1,235');expect(fn(1.234567,1)).toBe('1.2');expect(fn(1111111111)).toBe('1,111,111,111.000');expect(fn(1111111111,2,'.','-')).toBe('1-111-111-111.00');expect(fn(2,4)).toBe('2.0000');expect(fn(1250,2)).toBe('1,250.00');expect(fn(1250,2)).toBe('1,250.00');expect(fn(2000,2,'.','.')).toBe('2.000.00');expect(fn(1e-8,8,'.','')).toBe('0.00000001');});});describe('truncate',function(){var fn=avalon.filters.truncate;it('test',function(){expect(fn('大跃进大发展',5,'***')).toBe('大跃***');expect(fn('1122dsfdsfdsfdsfdffsfdsfewrewrw5')).toBe('1122dsfdsfdsfdsfdffsfdsfewr...');expect(fn('1122dsfdsfdsfdsfdffsfdsfewrewrw5',-5)).toBe('1122dsfdsfdsfdsfdffsfdsf...');expect(fn(null)).toBe('');expect(fn('')).toBe('');});});describe('currency',function(){var fn=avalon.filters.currency;it('test',function(){expect(fn(2500)).toBe('¥2,500.00');expect(fn(2500,'RMB')).toBe('RMB2,500.00');});});describe('filterBy',function(){var fn=avalon.filters.filterBy;it('test',function(){try{fn(111);}catch(e){expect(e).toBe('filterBy只能处理对象或数组');}expect(fn(['aaa','bbaa','ccc','daad'],'aa')).toEqual(['aaa','bbaa','daad']);expect(fn(['aaa','bbaa','ccc','ddd'],'')).toEqual(['aaa','bbaa','ccc','ddd']);expect(fn(['aa11','1122','66','2113'],11)).toEqual(['aa11','1122','2113']);expect(fn(['aaa','bbaa','ccc','ddd'],true)).toEqual(['aaa','bbaa','ccc','ddd']);expect(fn(['aa11','1122','66','2113'],function(a){return /2/.test(a);})).toEqual(['1122','2113']);expect(fn({a:111,b:212,c:332},function(a){return /2/.test(a);})).toEqual({b:212,c:332});});});describe('selectBy',function(){var fn=avalon.filters.selectBy;it('test',function(){expect(fn('aaa','aa')).toEqual('aaa');expect(fn(['aaa','bbaa','ccc','ddd'],'')).toEqual(['aaa','bbaa','ccc','ddd']);expect(fn({aaa:1,bbb:2,ccc:3},['aaa','bbb'])).toEqual([1,2]);expect(fn({aaa:1,bbb:2,ccc:3},['aaa','bbb','ddd'],{ddd:4})).toEqual([1,2,4]);});});describe('limitBy',function(){var fn=avalon.filters.limitBy;it('test',function(){try{fn(1111);}catch(e){expect(e).toEqual('limitBy只能处理对象或数组');}expect(fn([11],'ddd')).toEqual([11]);expect(fn([11],NaN)).toEqual([11]);expect(fn({a:1,b:2,c:3},2)).toEqual({a:1,b:2});expect(fn([111,222,333,444,555],2)).toEqual([111,222]);expect(fn([111,222,333,444,555],7)).toEqual([111,222,333,444,555]);expect(fn([111,222,333,444,555],2,2)).toEqual([333,444]);expect(fn([111,222,333,444,555,666],2,-2)).toEqual([555,666]);expect(fn([111,222,333,444,555,666],3.5)).toEqual([111,222,333]);});});describe('orderBy',function(){var fn=avalon.filters.orderBy;it('test',function(){try{fn(1111);}catch(e){expect(e).toEqual('orderBy只能处理对象或数组');}expect(fn([{a:1},{a:3},{a:2},{a:4}],'a',1)).toEqual([{a:1},{a:2},{a:3},{a:4}]);expect(fn([{a:1},{a:3},{a:2},{a:5}],'a',-1)).toEqual([{a:5},{a:3},{a:2},{a:1}]);var newArr=fn([{a:1},{a:NaN},{a:2},{a:NaN}],'a');expect(newArr).toEqual([{a:1},{a:2},{a:NaN},{a:NaN}]);expect(newArr.map(function(el){return el.a;}).join(',')).toBe('1,2,NaN,NaN');expect(fn([1,3,8,2],111)).toEqual([1,2,3,8]);expect(fn([111,222,33,444,5585],function(a){return String(a).length;})).toEqual([33,111,222,444,5585]);expect(fn({a:{v:4},d:{v:1},rr:{v:3},e33:{v:2}},'v')).toEqual({d:{v:1},e33:{v:2},rr:{v:3},a:{v:4}});});});describe('date',function(){var fn=avalon.filters.date;it('test',function(){var format='yyyy MM dd';expect(fn(new Date('2014/4/1'),format)).toBe('2014 04 01');expect(fn('2011/07/08',format)).toBe('2011 07 08');expect(fn('2011-07-08',format)).toBe('2011 07 08');expect(fn('01-10-2000',format)).toBe('2000 01 10');expect(fn('07 04,2000',format)).toBe('2000 07 04');expect(fn('3 14,2000',format)).toBe('2000 03 14');expect(fn('1373021259229',format)).toBe('2013 07 05');expect(fn('2014-06-10T15:21:2',format)).toBe('2014 06 10');expect(fn('2014-12-07T22:50:58.33+08:00',format)).toBe('2014 12 07');expect(fn('2015-01-31 00:00:00','yyyy-MM-dd')).toBe('2015-01-31');expect(fn('\/Date(1216796600500)\/','yyyy-MM-dd')).toBe('2008-07-23');expect(fn(1373021259229,format)).toBe('2013 07 05');expect(fn(new Date('2014/4/1'),'yyyy MM dd')).toBe('2014 04 01');expect(fn('1373021259229','yyyy MM dd')).toBe('2013 07 05');expect(fn(1373021259229,'yyyy MM dd')).toBe('2013 07 05');expect(fn('2014-12-07T22:50:58+08:00','yyyy MM dd')).toBe('2014 12 07');expect(fn('\/Date(1373021259229)\/','yyyy MM dd')).toBe('2013 07 05');});it('EEE',function(){var date=new Date(2016,7,26);expect(fn(date,'EEEE')).toBe('星期五');expect(fn(date,'EEE')).toBe('周五');expect(fn(date,'MMMM')).toBe('8月');expect(fn(date,'MMM')).toBe('8月');});it('Z',function(){var date=new Date(2016,7,26);expect(fn(date,'Z')).toMatch(/(-|\+)\d+/);});it('shortName',function(){var date=new Date(2016,7,26,12,4,5);expect(fn(date)).toBe('2016-8-26');expect(fn(date,'medium')).toBe('2016-8-26 12:04:05');expect(fn(date,'short')).toBe('16-8-26 下午12:04');expect(fn(date,'fullDate')).toBe('2016年8月26日星期五');expect(fn(date,'yyyy-MM-dd a')).toBe('2016-08-26 下午');date=new Date(2016,7,26,8,4,5);expect(fn(date,'yyyy-MM-dd a')).toBe('2016-08-26 上午');});});describe('事件过滤器',function(){it("$return",function(){var fn=avalon.filters.enter;var e={which:11};fn(e);expect(e.$return).toBe(true);var e={which:13};fn(e);expect(e.$return).toBe(void 0);});it('stop and prevent',function(){var e={stopPropagation:function stopPropagation(){},preventDefault:function preventDefault(){}};spyOn(e,'stopPropagation');spyOn(e,'preventDefault');avalon.filters.stop(e);avalon.filters.prevent(e);expect(e.stopPropagation).toHaveBeenCalled();expect(e.preventDefault).toHaveBeenCalled();});});});function VText(text){this.nodeName='#text';this.nodeValue=text;this.skipContent=!config.rexpr.test(text);}VText.prototype={constructor:VText,toDOM:function toDOM(){/* istanbul ignore if*/if(this.dom)return this.dom;var v=avalon._decode(this.nodeValue);return this.dom=document$1.createTextNode(v);},toHTML:function toHTML(){return this.nodeValue;}};function VComment(text){this.nodeName='#comment';this.nodeValue=text;}VComment.prototype={constructor:VComment,toDOM:function toDOM(){return this.dom=document$1.createComment(this.nodeValue);},toHTML:function toHTML(){return'<!--'+this.nodeValue+'-->';}};function VElement(type,props,children,isVoidTag){this.nodeName=type;this.props=props;this.children=children;this.isVoidTag=isVoidTag;}function skipFalseAndFunction(a){return a!==false&&Object(a)!==a;}/* istanbul ignore next */var specalAttrs={"class":function _class(dom,val){dom.className=val;},style:function style(dom,val){dom.style.cssText=val;},type:function type(dom,val){try{//textarea,button 元素在IE6,7设置 type 属性会抛错
dom.type=val;}catch(e){}},'for':function _for(dom,val){dom.htmlFor=val;}};VElement.prototype={constructor:VElement,toDOM:function toDOM(){if(this.dom)return this.dom;var dom,tagName=this.nodeName;if(avalon.modern&&svgTags[tagName]){dom=createSVG(tagName);/* istanbul ignore next*/}else if(!avalon.modern&&(VMLTags[tagName]||rvml.test(tagName))){dom=createVML(tagName);}else{dom=document$1.createElement(tagName);}var props=this.props||{};for(var i in props){var val=props[i];if(skipFalseAndFunction(val)){/* istanbul ignore if*/if(specalAttrs[i]&&avalon.msie<8){specalAttrs[i](dom,val);}else{dom.setAttribute(i,val+'');}}}var c=this.children||[];var template=c[0]?c[0].nodeValue:'';switch(this.nodeName){case'script':dom.text=template;break;case'style':/* istanbul ignore if*/if('styleSheet'in dom){dom.setAttribute('type','text/css');dom.styleSheet.cssText=template;}else{dom.innerHTML=template;}break;case'xmp'://IE6-8,XMP元素里面只能有文本节点,不能使用innerHTML
case'noscript':dom.innerText=dom.textContent=template;break;case'template':dom.innerHTML=template;break;default:if(!this.isVoidTag){this.children.forEach(function(c){c&&dom.appendChild(avalon.vdom(c,'toDOM'));});}break;}return this.dom=dom;},toHTML:function toHTML(){var arr=[];var props=this.props||{};for(var i in props){var val=props[i];if(skipFalseAndFunction(val)){arr.push(i+'='+avalon.quote(props[i]+''));}}arr=arr.length?' '+arr.join(' '):'';var str='<'+this.nodeName+arr;if(this.isVoidTag){return str+'/>';}str+='>';if(this.children){str+=this.children.map(function(c){return c?avalon.vdom(c,'toHTML'):'';}).join('');}return str+'</'+this.nodeName+'>';}};function createSVG(type){return document$1.createElementNS('http://www.w3.org/2000/svg',type);}var svgTags=avalon.oneObject('circle,defs,ellipse,image,line,'+'path,polygon,polyline,rect,symbol,text,use,g,svg');var rvml=/^\w+\:\w+/;/* istanbul ignore next*/function createVML(type){if(document$1.styleSheets.length<31){document$1.createStyleSheet().addRule(".rvml","behavior:url(#default#VML)");}else{// no more room, add to the existing one
// http://msdn.microsoft.com/en-us/library/ms531194%28VS.85%29.aspx
document$1.styleSheets[0].addRule(".rvml","behavior:url(#default#VML)");}var arr=type.split(':');if(arr.length===1){arr.unshift('v');}var tag=arr[1];var ns=arr[0];if(!document$1.namespaces[ns]){document$1.namespaces.add(ns,"urn:schemas-microsoft-com:vml");}return document$1.createElement('<'+ns+':'+tag+' class="rvml">');}var VMLTags=avalon.oneObject('shape,line,polyline,rect,roundrect,oval,arc,'+'curve,background,image,shapetype,group,fill,'+'stroke,shadow, extrusion, textbox, imagedata, textpath');function VFragment(a){this.nodeName='#document-fragment';this.children=a;}VFragment.prototype={constructor:VFragment,toDOM:function toDOM(){if(this.dom)return this.dom;var f=createFragment();var c=this.children||[];//IE6-11 docment-fragment都没有children属性 
for(var i=0,el;el=c[i++];){f.appendChild(avalon.vdom(el,'toDOM'));}this.split=f.lastChild;return this.dom=f;},toHTML:function toHTML(){var c=this.children||[];return c.map(function(a){return avalon.vdom(a,'toHTML');}).join('');}};/**
 * 虚拟DOM的4大构造器
 */var vdom=avalon.vdom=avalon.vdomAdaptor=function(obj,method){if(!obj){//obj在ms-for循环里面可能是null
return method==="toHTML"?'':createFragment();}switch(obj.nodeName){case'#text':return VText.prototype[method].call(obj);case'#comment':return VComment.prototype[method].call(obj);case'#document-fragment':return VFragment.prototype[method].call(obj);default:return VElement.prototype[method].call(obj);}};avalon.domize=function(a){return avalon.vdom(a,'toDOM');};describe('vdom',function(){describe('VElement',function(){it('test',function(){var el=new VElement('p',{title:'111'},[]);expect(el).toInstanceOf(VElement);expect(el).not.toHaveProperty('toDOM');expect(el).not.toHaveProperty('toHTML');expect(el.toDOM().title).toBe('111');expect(el.toHTML().toLowerCase()).toBe('<p title="111"></p>');if(avalon.modern){var circle=new VElement('circle',{},[]);expect(circle.toDOM().nodeName).toBe('circle');var template=new VElement('template',{},[new VText('111')]);expect(template.toDOM().nodeName).toBe('TEMPLATE');}var xmp=new VElement('xmp',{'for':'eee','class':'a b',style:'border: 4px'},[new VText('111')]);expect(xmp.toDOM().nodeName).toBe('XMP');expect(xmp.toDOM().className).toBe('a b');expect(xmp.toDOM().style.borderWidth).toMatch(/4/i);var noscript=new VElement('noscript',{},[new VText('111')]);expect(noscript.toDOM().nodeName).toBe('NOSCRIPT');expect(noscript.toDOM().innerText).toBe('111');var label=new VElement('label',{'for':'ddd'},[new VText('111')]);expect(label.toDOM().htmlFor).toBe('ddd');var style=new VElement('style',{},[new VText('.blue{color:blue}')]);expect(style.toDOM().nodeName).toBe('STYLE');var script=new VElement('script',{},[new VText('var a = 1')]);expect(script.toDOM().nodeName).toBe('SCRIPT');expect(script.toDOM().text).toBe('var a = 1');var input=new VElement('input',{type:'password'},[],true);expect(input.toDOM().nodeName).toBe('INPUT');expect(input.toDOM().type).toBe('password');expect(input.toHTML()).toBe('<input type="password"/>');expect(vdom(input,'toDOM').nodeName).toBe('INPUT');});});describe('VComment',function(){it('test',function(){var el=new VComment('aaa');expect(el).toInstanceOf(VComment);expect(el).not.toHaveProperty('toDOM');expect(el).not.toHaveProperty('toHTML');expect(el.nodeValue).toBe('aaa');expect(el.nodeName).toBe('#comment');expect(el.toDOM().nodeType).toBe(8);expect(el.toHTML()).toBe('<!--aaa-->');expect(vdom(el,'toDOM')).toBe(el.dom);});});describe('VText',function(){it('test',function(){var el=new VText('aaa');expect(el).toInstanceOf(VText);expect(el).toHaveProperty('nodeValue');expect(vdom(el,'toDOM')).toBe(el.dom);expect(avalon.domize(el)).toBe(el.dom);});});describe('VFragment',function(){it('test',function(){var el=new VFragment([]);expect(el).toInstanceOf(VFragment);expect(el).not.toHaveProperty('toDOM');expect(el).not.toHaveProperty('toHTML');expect(el.children).toEqual([]);expect(el.nodeName).toBe('#document-fragment');expect(el.toDOM().nodeType).toBe(11);expect(el.toHTML()).toBe('');expect(el.toDOM().nodeType).toBe(11);});it('test2',function(){var hasChildren=new VFragment([new VElement('p',{},[new VText('ooooo')])]);expect(hasChildren.toDOM().childNodes.length).toBe(1);expect(hasChildren.toHTML()).toBe('<p>ooooo</p>');});});describe('vdom',function(){it('test',function(){var el=vdom(null,'toHTML');expect(el).toBe('');var el2=vdom(null,'toDOM');expect(el2.nodeType).toBe(11);});});});var rcheckedType=/^(?:checkbox|radio)$/;/* istanbul ignore next */function fixElement(dest,src){if(dest.nodeType!==1){return;}var nodeName=dest.nodeName.toLowerCase();if(nodeName==='object'){if(dest.parentNode){dest.outerHTML=src.outerHTML;}}else if(nodeName==='input'&&rcheckedType.test(src.nodeName)){dest.defaultChecked=dest.checked=src.checked;if(dest.value!==src.value){dest.value=src.value;}}else if(nodeName==='option'){dest.defaultSelected=dest.selected=src.defaultSelected;}else if(nodeName==='input'||nodeName==='textarea'){dest.defaultValue=src.defaultValue;}}/* istanbul ignore next */function getAll(context){return typeof context.getElementsByTagName!=='undefined'?context.getElementsByTagName('*'):typeof context.querySelectorAll!=='undefined'?context.querySelectorAll('*'):[];}/* istanbul ignore next */function fixClone(src){var target=src.cloneNode(true);var t=getAll(target);var s=getAll(src);for(var i=0;i<s.length;i++){fixElement(t[i],s[i]);}return target;}/* istanbul ignore next */function fixContains(root,el){try{//IE6-8,游离于DOM树外的文本节点，访问parentNode有时会抛错
while(el=el.parentNode){if(el===root)return true;}}catch(e){}return false;}avalon.contains=fixContains;avalon.cloneNode=function(a){return a.cloneNode(true);};//IE6-11的文档对象没有contains
/* istanbul ignore next */function shimHack(){if(msie<10){avalon.cloneNode=fixClone;}if(!document$1.contains){document$1.contains=function(b){return fixContains(document$1,b);};}if(window$1.Node&&!document$1.createTextNode('x').contains){Node.prototype.contains=function(child){//IE6-8没有Node对象
return fixContains(this,child);};}//firefox 到11时才有outerHTML
if(window$1.HTMLElement&&!avalon.root.outerHTML){HTMLElement.prototype.__defineGetter__('outerHTML',function(){var div=document$1.createElement('div');div.appendChild(this);return div.innerHTML;});}}if(inBrowser){try{shimHack();}catch(e){avalon.log(e,'shimHack error');}}function scan(){}var readyList=[];function fireReady(fn){avalon.isReady=true;while(fn=readyList.shift()){fn(avalon);}}avalon.scan=scan;avalon.ready=function(fn){readyList.push(fn);if(avalon.isReady){fireReady();}};avalon.ready(function(){avalon.scan(document$1.body);});/* istanbul ignore next */function bootstrap(){function doScrollCheck(){try{//IE下通过doScrollCheck检测DOM树是否建完
root.doScroll('left');fireReady();}catch(e){setTimeout(doScrollCheck);}}if(document$1.readyState==='complete'){setTimeout(fireReady);//如果在domReady之外加载
}else if(document$1.addEventListener){document$1.addEventListener('DOMContentLoaded',fireReady);}else if(document$1.attachEvent){document$1.attachEvent('onreadystatechange',function(){if(document$1.readyState==='complete'){fireReady();}});try{var isTop=window$1.frameElement===null;}catch(e){}if(root.doScroll&&isTop&&window$1.external){//fix IE iframe BUG
doScrollCheck();}}avalon.bind(window$1,'load',fireReady);}if(inBrowser){bootstrap();}describe('shim',function(){it('avalon.cloneNode',function(){//注意,不要复制html元素 
var div=document.createElement('map');var map=avalon.cloneNode(div);expect(map.nodeName).toBe('MAP');});it('avalon.contains',function(done){avalon.ready(function(){expect(avalon.contains(avalon.root,document.body)).toBe(true);done();});});});describe('ready',function(){it('isReady',function(){expect(avalon.isReady).toBe(true);var a=1;avalon.isReady=false;avalon.ready(function(){a=2;});fireReady();expect(avalon.isReady).toBe(true);expect(a).toBe(2);avalon.ready(function(){a=3;});expect(a).toBe(3);});});function getDuplexType(elem){var ret=elem.tagName.toLowerCase();if(ret==='input'){return rcheckedType.test(elem.type)?'checked':elem.type;}return ret;}var roption=/^<option(?:\s+\w+(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^\s>]+))?)*\s+value[\s=]/i;function option(node){//在IE11及W3C，如果没有指定value，那么node.value默认为node.text（存在trim作），但IE9-10则是取innerHTML(没trim操作)
//specified并不可靠，因此通过分析outerHTML判定用户有没有显示定义value
return roption.test(node.outerHTML)?node.value:node.text.trim();}var valHooks={'option:get':msie?option:function(node){return node.value;},'select:get':function selectGet(node,value){var option$$1,options=node.options,index=node.selectedIndex,getter=valHooks['option:get'],one=node.type==='select-one'||index<0,values=one?null:[],max=one?index+1:options.length,i=index<0?max:one?index:0;for(;i<max;i++){option$$1=options[i];//IE6-9在reset后不会改变selected，需要改用i === index判定
//我们过滤所有disabled的option元素，但在safari5下，
//如果设置optgroup为disable，那么其所有孩子都disable
//因此当一个元素为disable，需要检测其是否显式设置了disable及其父节点的disable情况
if((option$$1.selected||i===index)&&!option$$1.disabled&&(!option$$1.parentNode.disabled||option$$1.parentNode.tagName!=='OPTGROUP')){value=getter(option$$1);if(one){return value;}//收集所有selected值组成数组返回
values.push(value);}}return values;},'select:set':function selectSet(node,values,optionSet){values=[].concat(values);//强制转换为数组
var getter=valHooks['option:get'];for(var i=0,el;el=node.options[i++];){if(el.selected=values.indexOf(getter(el))>-1){optionSet=true;}}if(!optionSet){node.selectedIndex=-1;}}};avalon.fn.val=function(value){var node=this[0];if(node&&node.nodeType===1){var get=arguments.length===0;var access=get?':get':':set';var fn=valHooks[getDuplexType(node)+access];if(fn){var val=fn(node,value);}else if(get){return(node.value||'').replace(/\r/g,'');}else{node.value=value;}}return get?val:this;};describe('value',function(){var a,b,c,d,e,f;beforeEach(function(){a=document.createElement("option");var div=document.createElement('div');div.innerHTML='<input type="radio" /><input type="checkbox" />';b=div.children[0];c=div.children[1];d=document.createElement('textarea');e=document.createElement('select');f=document.createElement('input');});it('option',function(){a.innerText=' 111 ';expect(option(a)).toBe('111');a.setAttribute('value',' 222 ');expect(option(a)).toBe(' 222 ');});it('getDuplexType',function(){expect(getDuplexType(a)).toBe('option');expect(getDuplexType(b)).toBe('checked');expect(getDuplexType(c)).toBe('checked');expect(getDuplexType(d)).toBe('textarea');expect(getDuplexType(e)).toBe('select');expect(getDuplexType(f)).toBe('text');});it('fn.val',function(){expect(avalon(a).val()).toBe('');avalon(a).val(333);expect(avalon(a).val()).toBe('333');avalon(f).val('dd');expect(avalon(f).val()).toBe('dd');e.options.add(new Option("aa","111"));e.options.add(new Option("bb","222"));e.options.add(new Option("cc","333"));expect(avalon(e).val()).toBe('111');avalon(e).val('222');expect(avalon(e).val()).toBe('222');expect(e.children[1].selected).toBe(true);e.multiple=true;e.options.add(new Option("dd","444"));e.children[0].disabled=true;expect(avalon(e).val()).toEqual(['222']);avalon(e).val([]);expect(e.children[1].selected).toBe(false);});});function ClassList(node){this.node=node;}ClassList.prototype={toString:function toString(){var node=this.node;var cls=node.className;var str=typeof cls==='string'?cls:cls.baseVal;var match=str.match(rnowhite);return match?match.join(' '):'';},contains:function contains(cls){return(' '+this+' ').indexOf(' '+cls+' ')>-1;},add:function add(cls){if(!this.contains(cls)){this.set(this+' '+cls);}},remove:function remove(cls){this.set((' '+this+' ').replace(' '+cls+' ',' '));},set:function set(cls){cls=cls.trim();var node=this.node;if(_typeof(node.className)==='object'){//SVG元素的className是一个对象 SVGAnimatedString { baseVal='', animVal=''}，只能通过set/getAttribute操作
node.setAttribute('class',cls);}else{node.className=cls;}}//toggle存在版本差异，因此不使用它
};function classListFactory(node){if(!('classList'in node)){node.classList=new ClassList(node);}return node.classList;}'add,remove'.replace(rword,function(method){avalon.fn[method+'Class']=function(cls){var el=this[0]||{};//https://developer.mozilla.org/zh-CN/docs/Mozilla/Firefox/Releases/26
if(cls&&typeof cls==='string'&&el.nodeType===1){cls.replace(rnowhite,function(c){classListFactory(el)[method](c);});}return this;};});avalon.shadowCopy(avalon.fn,{hasClass:function hasClass(cls){var el=this[0]||{};return el.nodeType===1&&classListFactory(el).contains(cls);},toggleClass:function toggleClass(value,stateVal){var isBool=typeof stateVal==='boolean';var me=this;String(value).replace(rnowhite,function(c){var state=isBool?stateVal:!me.hasClass(c);me[state?'addClass':'removeClass'](c);});return this;}});describe('class',function(){it('ClassList',function(){var node={setAttribute:function setAttribute(name,cls){this.className={baseVal:cls};},className:{baseVal:''}};var ss=classListFactory(node);expect(ss).toInstanceOf(ClassList);ss.add('aaa');ss.add('bbb');expect(ss+"").toBe('aaa bbb');expect(ss.contains('bbb')).toBe(true);ss.remove('bbb');ss.add('er');expect(ss+'').toBe('aaa er');//=========
node.className="";node.setAttribute=function(_,cls){node.className=cls;};//=======
ss.add('last');//jasmine
expect(ss.node.className).toBe('last');if(avalon.modern){var textPath=document.createElementNS("http://www.w3.org/2000/svg","textPath");expect(typeof textPath==='undefined'?'undefined':_typeof(textPath)).toBe('object');avalon(textPath).addClass('aaa bbb ccc');expect(textPath.getAttribute('class')).toBe('aaa bbb ccc');avalon(textPath).removeClass('aaa ccc');expect(textPath.getAttribute('class')).toBe('bbb');}var div=document.createElement("div");avalon(div).addClass('aaa bbb ccc');expect(div.className).toBe('aaa bbb ccc');avalon(div).removeClass('aaa ccc');expect(div.className).toBe('bbb');avalon(div).toggleClass('eee');expect(div.className).toBe('bbb eee');avalon(div).toggleClass('eee');expect(div.className).toBe('bbb');avalon(div).toggleClass('bbb',false);expect(div.className).toBe('');avalon(div).toggleClass('ccc fff',true);expect(div.className).toBe('ccc fff');});});var rhtml=/<|&#?\w+;/;var htmlCache=new Cache(128);var rxhtml=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig;avalon.parseHTML=function(html){var fragment=createFragment();//处理非字符串
if(typeof html!=='string'){return fragment;}//处理非HTML字符串
if(!rhtml.test(html)){return document$1.createTextNode(html);}html=html.replace(rxhtml,'<$1></$2>').trim();var hasCache=htmlCache.get(html);if(hasCache){return avalon.cloneNode(hasCache);}var vnodes=avalon.lexer(html);for(var i=0,el;el=vnodes[i++];){fragment.appendChild(avalon.vdom(el,'toDOM'));}if(html.length<1024){htmlCache.put(html,fragment);}return fragment;};avalon.innerHTML=function(node,html){var parsed=this.parseHTML(html);this.clearHTML(node).appendChild(parsed);};//https://github.com/karloespiritu/escapehtmlent/blob/master/index.js
avalon.unescapeHTML=function(html){return String(html).replace(/&quot;/g,'"').replace(/&#39;/g,'\'').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&');};avalon.clearHTML=function(node){node.textContent='';/* istanbul ignore next */while(node.lastChild){node.removeChild(node.lastChild);}return node;};describe('html',function(){var unescape=avalon.unescapeHTML;describe('unescapeHTML',function(){it('converts &amp; into &',function(){expect(unescape('&amp;')).toBe('&');});it('converts &quot; into "',function(){expect(unescape('&quot;')).toBe('"');});it('converts &#39; into \'',function(){expect(unescape('&#39;')).toBe('\'');});it('converts &lt; into <',function(){expect(unescape('&lt;')).toBe('<');});it('converts &gt; into >',function(){expect(unescape('&gt;')).toBe('>');});});describe('clearHTML',function(){it('test',function(){var div=document.createElement('div');div.innerHTML="<p>ddd</p><b>333</b>";avalon.clearHTML(div);expect(div.childNodes.length).toBe(0);});});describe('clearHTML',function(){var oldLexer;beforeEach(function(){oldLexer=avalon.lexer;avalon.lexer=function(){return[{nodeName:'div',props:{},children:[{nodeName:'#text',nodeValue:'222'}]},{nodeName:'div',props:{},children:[{nodeName:'#text',nodeValue:'222'}]}];};});afterEach(function(){avalon.lexer=oldLexer;});it('avalon.parseHTML && innerHTML',function(){var a=avalon.parseHTML(null);expect(a.nodeType).toBe(11);var b=avalon.parseHTML('111');expect(b.nodeType).toBe(3);var c=avalon.parseHTML('<div>222</div><div>222</div>');expect(c.nodeType).toBe(11);expect(c.childNodes.length).toBe(2);var div=document.createElement('div');div.innerHTML="<p>ddd</p><b>333</b>";avalon.innerHTML(div,'<div>222</div><div>222</div>');expect(div.getElementsByTagName('div').length).toBe(2);});});});var propMap={//不规则的属性名映射
'accept-charset':'acceptCharset','char':'ch',charoff:'chOff','class':'className','for':'htmlFor','http-equiv':'httpEquiv'};/*
contenteditable不是布尔属性
http://www.zhangxinxu.com/wordpress/2016/01/contenteditable-plaintext-only/
contenteditable=''
contenteditable='events'
contenteditable='caret'
contenteditable='plaintext-only'
contenteditable='true'
contenteditable='false'
 */var bools=['autofocus,autoplay,async,allowTransparency,checked,controls','declare,disabled,defer,defaultChecked,defaultSelected,','isMap,loop,multiple,noHref,noResize,noShade','open,readOnly,selected'].join(',');bools.replace(/\w+/g,function(name){propMap[name.toLowerCase()]=name;});var anomaly=['accessKey,bgColor,cellPadding,cellSpacing,codeBase,codeType,colSpan','dateTime,defaultValue,contentEditable,frameBorder,longDesc,maxLength,'+'marginWidth,marginHeight,rowSpan,tabIndex,useMap,vSpace,valueType,vAlign'].join(',');anomaly.replace(/\w+/g,function(name){propMap[name.toLowerCase()]=name;});//module.exports = propMap
function isVML(src){var nodeName=src.nodeName;return nodeName.toLowerCase()===nodeName&&!!src.scopeName&&src.outerText==='';}var rvalidchars=/^[\],:{}\s]*$/;var rvalidbraces=/(?:^|:|,)(?:\s*\[)+/g;var rvalidescape=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g;var rvalidtokens=/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g;function compactParseJSON(data){if(typeof data==='string'){data=data.trim();if(data){if(rvalidchars.test(data.replace(rvalidescape,'@').replace(rvalidtokens,']').replace(rvalidbraces,''))){return new Function('return '+data)();// jshint ignore:line
}}throw TypeError('Invalid JSON: ['+data+']');}return data;}var rsvg=/^\[object SVG\w*Element\]$/;var ramp=/&amp;/g;function updateAttr(node,vnode){/* istanbul ignore if*/if(!node||node.nodeType!==1){return;}vnode.dynamic['ms-attr']=1;var attrs=vnode['ms-attr'];for(var attrName in attrs){var val=attrs[attrName];// 处理路径属性
/* istanbul ignore if*/if(attrName==='href'||attrName==='src'){if(msie<8){val=String(val).replace(ramp,'&');//处理IE67自动转义的问题
}node[attrName]=val;//处理HTML5 data-*属性
}else if(attrName.indexOf('data-')===0){node.setAttribute(attrName,val);}else{var propName=propMap[attrName]||attrName;/* istanbul ignore if */if(typeof node[propName]==='boolean'){node[propName]=!!val;//布尔属性必须使用el.xxx = true|false方式设值
//如果为false, IE全系列下相当于setAttribute(xxx,''),
//会影响到样式,需要进一步处理
}if(val===false){//移除属性
node.removeAttribute(propName);continue;}//SVG只能使用setAttribute(xxx, yyy), VML只能使用node.xxx = yyy ,
//HTML的固有属性必须node.xxx = yyy
var isInnate=rsvg.test(node)?false:!avalon.modern&&isVML(node)?true:attrName in node.cloneNode(false);/* istanbul ignore next */if(isInnate){node[propName]=val+'';}else{node.setAttribute(attrName,val);}}}}try{avalon.parseJSON=JSON.parse;}catch(e){/* istanbul ignore next */avalon.parseJSON=compactParseJSON;}avalon.fn.attr=function(name,value){if(arguments.length===2){this[0].setAttribute(name,value);return this;}else{return this[0].getAttribute(name);}};describe('attr',function(){describe('updateAttr',function(){it('test',function(){var vnode={dynamic:{},'ms-attr':{src:'https://github.com/ecomfe/zrender',href:'https://github.com/ecomfe/zrender','data-title':"aaa",'for':'bbb','aaa':false,'class':'eee'}};var option=document.createElement('option');option.setAttribute('aaa','111');updateAttr(option,vnode);expect(option.src).toBe('https://github.com/ecomfe/zrender');expect(option.href).toBe('https://github.com/ecomfe/zrender');expect(option.getAttribute('data-title')).toBe('aaa');expect(option.getAttribute('aaa')).toBe(null);expect(option.getAttribute('for')).toBe('bbb');expect(option.className).toBe('eee');avalon(option).attr("title",'222');expect(avalon(option).attr('title')).toBe('222');});});describe('compactParseJSON',function(){it('test',function(){expect(compactParseJSON()).toBe(void 0);expect(compactParseJSON(null)).toBe(null);expect(compactParseJSON("{}")).toEqual({});expect(compactParseJSON("{\"test\":1}")).toEqual({test:1});expect(compactParseJSON("\n{\"test\":1}")).toEqual({test:1});expect(function(){compactParseJSON("");}).toThrowError(TypeError);expect(function(){compactParseJSON("{a:1}");}).toThrowError(TypeError);expect(function(){compactParseJSON("{'a':1}");}).toThrowError(TypeError);});});describe('isVML',function(){it('test',function(){expect(!!isVML({nodeName:'oval'})).toBe(false);if(avalon.msie&&avalon.msie<9){var oval=document.createElement("v:oval");expect(isVML(oval)).toBe(true);}});});});//http://www.feiesoft.com/html/events.html
//http://segmentfault.com/q/1010000000687977/a-1020000000688757
var canBubbleUp={click:true,dblclick:true,keydown:true,keypress:true,keyup:true,mousedown:true,mousemove:true,mouseup:true,mouseover:true,mouseout:true,wheel:true,mousewheel:true,input:true,change:true,beforeinput:true,compositionstart:true,compositionupdate:true,compositionend:true,select:true,//http://blog.csdn.net/lee_magnum/article/details/17761441
cut:true,copy:true,paste:true,beforecut:true,beforecopy:true,beforepaste:true,focusin:true,focusout:true,DOMFocusIn:true,DOMFocusOut:true,DOMActivate:true,dragend:true,datasetchanged:true};/* istanbul ignore if */var hackSafari=avalon.modern&&document$1.ontouchstart;//添加fn.bind, fn.unbind, bind, unbind
avalon.fn.bind=function(type,fn,phase){if(this[0]){//此方法不会链
return avalon.bind(this[0],type,fn,phase);}};avalon.fn.unbind=function(type,fn,phase){if(this[0]){var args=_slice.call(arguments);args.unshift(this[0]);avalon.unbind.apply(0,args);}return this;};/*绑定事件*/avalon.bind=function(elem,type,fn){if(elem.nodeType===1){var value=elem.getAttribute('avalon-events')||'';//如果是使用ms-on-*绑定的回调,其uuid格式为e12122324,
//如果是使用bind方法绑定的回调,其uuid格式为_12
var uuid=getShortID(fn);var hook=eventHooks[type];/* istanbul ignore if */if(type==='click'&&hackSafari){elem.addEventListener('click',avalon.noop);}/* istanbul ignore if */if(hook){type=hook.type||type;if(hook.fix){fn=hook.fix(elem,fn);fn.uuid=uuid;}}var key=type+':'+uuid;avalon.eventListeners[fn.uuid]=fn;/* istanbul ignore if */if(value.indexOf(type+':')===-1){//同一种事件只绑定一次
if(canBubbleUp[type]||avalon.modern&&focusBlur[type]){delegateEvent(type);}else{avalon._nativeBind(elem,type,dispatch);}}var keys=value.split(',');/* istanbul ignore if */if(keys[0]===''){keys.shift();}if(keys.indexOf(key)===-1){keys.push(key);elem.setAttribute('avalon-events',keys.join(','));//将令牌放进avalon-events属性中
}}else{/* istanbul ignore next */avalon._nativeBind(elem,type,fn);}return fn;//兼容之前的版本
};/* istanbul ignore next */avalon.unbind=function(elem,type,fn){if(elem.nodeType===1){var value=elem.getAttribute('avalon-events')||'';switch(arguments.length){case 1:avalon._nativeUnBind(elem,type,dispatch);elem.removeAttribute('avalon-events');break;case 2:value=value.split(',').filter(function(str){return str.indexOf(type+':')===-1;}).join(',');elem.setAttribute('avalon-events',value);break;default:var search=type+':'+fn.uuid;value=value.split(',').filter(function(str){return str!==search;}).join(',');elem.setAttribute('avalon-events',value);delete avalon.eventListeners[fn.uuid];break;}}else{avalon._nativeUnBind(elem,type,fn);}};var typeRegExp={};function collectHandlers(elem,type,handlers){var value=elem.getAttribute('avalon-events');if(value&&(elem.disabled!==true||type!=='click')){var uuids=[];var reg=typeRegExp[type]||(typeRegExp[type]=new RegExp("\\b"+type+'\\:([^,\\s]+)','g'));value.replace(reg,function(a,b){uuids.push(b);return a;});if(uuids.length){handlers.push({elem:elem,uuids:uuids});}}elem=elem.parentNode;var g=avalon.gestureEvents||{};if(elem&&elem.getAttribute&&(canBubbleUp[type]||g[type])){collectHandlers(elem,type,handlers);}}var stopImmediate=false;function dispatch(event){event=new avEvent(event);var type=event.type;var elem=event.target;var handlers=[];collectHandlers(elem,type,handlers);var i=0,j,uuid,handler;while((handler=handlers[i++])&&!event.cancelBubble){var host=event.currentTarget=handler.elem;j=0;while(uuid=handler.uuids[j++]){if(stopImmediate){stopImmediate=false;break;}var fn=avalon.eventListeners[uuid];if(fn){/*     var vm = rhandleHasVm.test(uuid) ? handler.elem._ms_context_ : 0
                if (vm && vm.$hashcode === false) {
                    return avalon.unbind(elem, type, fn)
                }*/var ret=fn.call(elem,event);if(ret===false){event.preventDefault();event.stopPropagation();}}}}}var focusBlur={focus:true,blur:true};function delegateEvent(type){var value=root.getAttribute('delegate-events')||'';if(value.indexOf(type)===-1){var arr=value.match(avalon.rword)||[];arr.push(type);root.setAttribute('delegate-events',arr.join(','));avalon._nativeBind(root,type,dispatch,!!focusBlur[type]);}}var rconstant=/^[A-Z_]+$/;function avEvent(event){if(event.originalEvent){return event;}for(var i in event){if(!rconstant.test(i)&&typeof event[i]!=='function'){this[i]=event[i];}}if(!this.target){this.target=event.srcElement;}var target=this.target;this.fixEvent();this.timeStamp=new Date()-0;this.originalEvent=event;}avEvent.prototype={fixEvent:function fixEvent(){},preventDefault:function preventDefault(){var e=this.originalEvent||{};e.returnValue=this.returnValue=false;if(e.preventDefault){e.preventDefault();}},stopPropagation:function stopPropagation(){var e=this.originalEvent||{};e.cancelBubble=this.cancelBubble=true;if(e.stopPropagation){e.stopPropagation();}},stopImmediatePropagation:function stopImmediatePropagation(){stopImmediate=true;this.stopPropagation();},toString:function toString(){return'[object Event]';//#1619
}};//针对firefox, chrome修正mouseenter, mouseleave
/* istanbul ignore if */if(!('onmouseenter'in root)){avalon.each({mouseenter:'mouseover',mouseleave:'mouseout'},function(origType,fixType){eventHooks[origType]={type:fixType,fix:function fix(elem,fn){return function(e){var t=e.relatedTarget;if(!t||t!==elem&&!(elem.compareDocumentPosition(t)&16)){delete e.type;e.type=origType;return fn.apply(this,arguments);}};}};});}//针对IE9+, w3c修正animationend
avalon.each({AnimationEvent:'animationend',WebKitAnimationEvent:'webkitAnimationEnd'},function(construct,fixType){if(window$1[construct]&&!eventHooks.animationend){eventHooks.animationend={type:fixType};}});/* istanbul ignore if */if(!("onmousewheel"in document$1)){/* IE6-11 chrome mousewheel wheelDetla 下 -120 上 120
     firefox DOMMouseScroll detail 下3 上-3
     firefox wheel detlaY 下3 上-3
     IE9-11 wheel deltaY 下40 上-40
     chrome wheel deltaY 下100 上-100 */var fixWheelType=document$1.onwheel!==void 0?'wheel':'DOMMouseScroll';var fixWheelDelta=fixWheelType==='wheel'?'deltaY':'detail';eventHooks.mousewheel={type:fixWheelType,fix:function fix(elem,fn){return function(e){var delta=e[fixWheelDelta]>0?-120:120;e.wheelDelta=~~elem._ms_wheel_+delta;elem._ms_wheel_=e.wheelDeltaY=e.wheelDelta;e.wheelDeltaX=0;if(Object.defineProperty){Object.defineProperty(e,'type',{value:'mousewheel'});}return fn.apply(this,arguments);};}};}/* istanbul ignore if */if(!modern){delete canBubbleUp.change;delete canBubbleUp.select;}/* istanbul ignore next */avalon._nativeBind=modern?function(el,type,fn,capture){el.addEventListener(type,fn,capture);}:function(el,type,fn){el.attachEvent('on'+type,fn);};/* istanbul ignore next */avalon._nativeUnBind=modern?function(el,type,fn){el.removeEventListener(type,fn);}:function(el,type,fn){el.detachEvent('on'+type,fn);};/* istanbul ignore next */avalon.fireDom=function(elem,type,opts){if(document$1.createEvent){var hackEvent=document$1.createEvent('Events');hackEvent.initEvent(type,true,true,opts);avalon.shadowCopy(hackEvent,opts);elem.dispatchEvent(hackEvent);}else if(root.contains(elem)){//IE6-8触发事件必须保证在DOM树中,否则报'SCRIPT16389: 未指明的错误'
hackEvent=document$1.createEventObject();avalon.shadowCopy(hackEvent,opts);elem.fireEvent('on'+type,hackEvent);}};var rmouseEvent=/^(?:mouse|contextmenu|drag)|click/;/* istanbul ignore next */avEvent.prototype.fixEvent=function(){var event=this;if(event.which==null&&event.type.indexOf('key')===0){event.which=event.charCode!=null?event.charCode:event.keyCode;}if(rmouseEvent.test(event.type)&&!('pageX'in event)){var DOC=event.target.ownerDocument||document$1;var box=DOC.compatMode==='BackCompat'?DOC.body:DOC.documentElement;event.pageX=event.clientX+(box.scrollLeft>>0)-(box.clientLeft>>0);event.pageY=event.clientY+(box.scrollTop>>0)-(box.clientTop>>0);event.wheelDeltaY=event.wheelDelta;event.wheelDeltaX=0;}};//针对IE6-8修正input
/* istanbul ignore if */if(!('oninput'in document$1.createElement('input'))){eventHooks.input={type:'propertychange',fix:function fix(elem,fn){return function(e){if(e.propertyName==='value'){e.type='input';return fn.apply(this,arguments);}};}};}describe('event',function(){it('avEvent',function(done){var event={srcElement:{},type:'click',keyCode:12,clientX:11,clientY:118,wheelDelta:0};var e=new avEvent(event);expect(e.target).toBe(event.srcElement);expect(e.originalEvent).toBe(event);expect(e.type).toBe('click');expect(e.pageX).toBe(11);expect(e.pageY).toBe(118);expect(e.wheelDelta).toBe(0);expect(e.preventDefault).toA('function');expect(e.stopPropagation).toA('function');expect(e.stopImmediatePropagation).toA('function');e.preventDefault();expect(e.returnValue).toBe(false);e.stopPropagation();expect(e.cancelBubble).toBe(true);e.cancelBubble=2;e.stopImmediatePropagation();expect(e.cancelBubble).toBe(true);expect(e+"").toMatch(/object\s+Event/);var e2=new avEvent(e);expect(e2).toBe(e);avalon.ready(function(){var div=document.createElement('div');document.body.appendChild(div);var changed=false;avalon(div).bind('click',function(){changed=true;return false;});avalon.fireDom(div,'click');fireClick(div);expect(changed).toBe(true);avalon(div).unbind('click');done();});});});var cssMap={'float':'cssFloat'};var cssHooks$1={};avalon.cssNumber=oneObject('animationIterationCount,columnCount,order,flex,flexGrow,flexShrink,fillOpacity,fontWeight,lineHeight,opacity,orphans,widows,zIndex,zoom');var prefixes=['','-webkit-','-o-','-moz-','-ms-'];/* istanbul ignore next */avalon.cssName=function(name,host,camelCase){if(cssMap[name]){return cssMap[name];}host=host||avalon.root.style||{};for(var i=0,n=prefixes.length;i<n;i++){camelCase=avalon.camelize(prefixes[i]+name);if(camelCase in host){return cssMap[name]=camelCase;}}return null;};/* istanbul ignore next */avalon.css=function(node,name,value,fn){//读写删除元素节点的样式
if(node instanceof avalon){node=node[0];}if(node.nodeType!==1){return;}var prop=avalon.camelize(name);name=avalon.cssName(prop)||/* istanbul ignore next*/prop;if(value===void 0||typeof value==='boolean'){//获取样式
fn=cssHooks$1[prop+':get']||cssHooks$1['@:get'];if(name==='background'){name='backgroundColor';}var val=fn(node,name);return value===true?parseFloat(val)||0:val;}else if(value===''){//请除样式
node.style[name]='';}else{//设置样式
if(value==null||value!==value){return;}if(isFinite(value)&&!avalon.cssNumber[prop]){value+='px';}fn=cssHooks$1[prop+':set']||cssHooks$1['@:set'];fn(node,name,value);}};/* istanbul ignore next */avalon.fn.css=function(name,value){if(avalon.isPlainObject(name)){for(var i in name){avalon.css(this,i,name[i]);}}else{var ret=avalon.css(this,name,value);}return ret!==void 0?ret:this;};/* istanbul ignore next */avalon.fn.position=function(){var offsetParent,offset,elem=this[0],parentOffset={top:0,left:0};if(!elem){return parentOffset;}if(this.css('position')==='fixed'){offset=elem.getBoundingClientRect();}else{offsetParent=this.offsetParent();//得到真正的offsetParent
offset=this.offset();// 得到正确的offsetParent
if(offsetParent[0].tagName!=='HTML'){parentOffset=offsetParent.offset();}parentOffset.top+=avalon.css(offsetParent[0],'borderTopWidth',true);parentOffset.left+=avalon.css(offsetParent[0],'borderLeftWidth',true);// Subtract offsetParent scroll positions
parentOffset.top-=offsetParent.scrollTop();parentOffset.left-=offsetParent.scrollLeft();}return{top:offset.top-parentOffset.top-avalon.css(elem,'marginTop',true),left:offset.left-parentOffset.left-avalon.css(elem,'marginLeft',true)};};/* istanbul ignore next */avalon.fn.offsetParent=function(){var offsetParent=this[0].offsetParent;while(offsetParent&&avalon.css(offsetParent,'position')==='static'){offsetParent=offsetParent.offsetParent;}return avalon(offsetParent||avalon.root);};/* istanbul ignore next */cssHooks$1['@:set']=function(node,name,value){try{//node.style.width = NaN;node.style.width = 'xxxxxxx';
//node.style.width = undefine 在旧式IE下会抛异常
node.style[name]=value;}catch(e){}};/* istanbul ignore next */cssHooks$1['@:get']=function(node,name){if(!node||!node.style){throw new Error('getComputedStyle要求传入一个节点 '+node);}var ret,styles=window$1.getComputedStyle(node,null);if(styles){ret=name==='filter'?styles.getPropertyValue(name):styles[name];if(ret===''){ret=node.style[name];//其他浏览器需要我们手动取内联样式
}}return ret;};cssHooks$1['opacity:get']=function(node){var ret=cssHooks$1['@:get'](node,'opacity');return ret===''?'1':ret;};'top,left'.replace(avalon.rword,function(name){cssHooks$1[name+':get']=function(node){var computed=cssHooks$1['@:get'](node,name);return /px$/.test(computed)?computed:avalon(node).position()[name]+'px';};});var cssShow={position:'absolute',visibility:'hidden',display:'block'};var rdisplayswap=/^(none|table(?!-c[ea]).+)/;/* istanbul ignore next */function showHidden(node,array){//http://www.cnblogs.com/rubylouvre/archive/2012/10/27/2742529.html
if(node.offsetWidth<=0){//opera.offsetWidth可能小于0
if(rdisplayswap.test(cssHooks$1['@:get'](node,'display'))){var obj={node:node};for(var name in cssShow){obj[name]=node.style[name];node.style[name]=cssShow[name];}array.push(obj);}var parent=node.parentNode;if(parent&&parent.nodeType===1){showHidden(parent,array);}}}/* istanbul ignore next*/avalon.each({Width:'width',Height:'height'},function(name,method){var clientProp='client'+name,scrollProp='scroll'+name,offsetProp='offset'+name;cssHooks$1[method+':get']=function(node,which,override){var boxSizing=-4;if(typeof override==='number'){boxSizing=override;}which=name==='Width'?['Left','Right']:['Top','Bottom'];var ret=node[offsetProp];// border-box 0
if(boxSizing===2){// margin-box 2
return ret+avalon.css(node,'margin'+which[0],true)+avalon.css(node,'margin'+which[1],true);}if(boxSizing<0){// padding-box  -2
ret=ret-avalon.css(node,'border'+which[0]+'Width',true)-avalon.css(node,'border'+which[1]+'Width',true);}if(boxSizing===-4){// content-box -4
ret=ret-avalon.css(node,'padding'+which[0],true)-avalon.css(node,'padding'+which[1],true);}return ret;};cssHooks$1[method+'&get']=function(node){var hidden=[];showHidden(node,hidden);var val=cssHooks$1[method+':get'](node);for(var i=0,obj;obj=hidden[i++];){node=obj.node;for(var n in obj){if(typeof obj[n]==='string'){node.style[n]=obj[n];}}}return val;};avalon.fn[method]=function(value){//会忽视其display
var node=this[0];if(arguments.length===0){if(node.setTimeout){//取得窗口尺寸
return node['inner'+name]||node.document.documentElement[clientProp]||node.document.body[clientProp];//IE6下前两个分别为undefined,0
}if(node.nodeType===9){//取得页面尺寸
var doc=node.documentElement;//FF chrome    html.scrollHeight< body.scrollHeight
//IE 标准模式 : html.scrollHeight> body.scrollHeight
//IE 怪异模式 : html.scrollHeight 最大等于可视窗口多一点？
return Math.max(node.body[scrollProp],doc[scrollProp],node.body[offsetProp],doc[offsetProp],doc[clientProp]);}return cssHooks$1[method+'&get'](node);}else{return this.css(method,value);}};avalon.fn['inner'+name]=function(){return cssHooks$1[method+':get'](this[0],void 0,-2);};avalon.fn['outer'+name]=function(includeMargin){return cssHooks$1[method+':get'](this[0],void 0,includeMargin===true?2:0);};});function getWindow(node){return node.window||node.defaultView||node.parentWindow||false;}/* istanbul ignore if */if(msie<9){cssMap['float']='styleFloat';var rnumnonpx=/^-?(?:\d*\.)?\d+(?!px)[^\d\s]+$/i;var rposition=/^(top|right|bottom|left)$/;var ralpha=/alpha\([^)]*\)/i;var ie8=msie===8;var salpha='DXImageTransform.Microsoft.Alpha';var border={thin:ie8?'1px':'2px',medium:ie8?'3px':'4px',thick:ie8?'5px':'6px'};cssHooks$1['@:get']=function(node,name){//取得精确值，不过它有可能是带em,pc,mm,pt,%等单位
var currentStyle=node.currentStyle;var ret=currentStyle[name];if(rnumnonpx.test(ret)&&!rposition.test(ret)){//①，保存原有的style.left, runtimeStyle.left,
var style=node.style,left=style.left,rsLeft=node.runtimeStyle.left;//②由于③处的style.left = xxx会影响到currentStyle.left，
//因此把它currentStyle.left放到runtimeStyle.left，
//runtimeStyle.left拥有最高优先级，不会style.left影响
node.runtimeStyle.left=currentStyle.left;//③将精确值赋给到style.left，然后通过IE的另一个私有属性 style.pixelLeft
//得到单位为px的结果；fontSize的分支见http://bugs.jquery.com/ticket/760
style.left=name==='fontSize'?'1em':ret||0;ret=style.pixelLeft+'px';//④还原 style.left，runtimeStyle.left
style.left=left;node.runtimeStyle.left=rsLeft;}if(ret==='medium'){name=name.replace('Width','Style');//border width 默认值为medium，即使其为0'
if(currentStyle[name]==='none'){ret='0px';}}return ret===''?'auto':border[ret]||ret;};cssHooks$1['opacity:set']=function(node,name,value){var style=node.style;var opacity=isFinite(value)&&value<=1?'alpha(opacity='+value*100+')':'';var filter=style.filter||'';style.zoom=1;//不能使用以下方式设置透明度
//node.filters.alpha.opacity = value * 100
style.filter=(ralpha.test(filter)?filter.replace(ralpha,opacity):filter+' '+opacity).trim();if(!style.filter){style.removeAttribute('filter');}};cssHooks$1['opacity:get']=function(node){//这是最快的获取IE透明值的方式，不需要动用正则了！
var alpha=node.filters.alpha||node.filters[salpha],op=alpha&&alpha.enabled?alpha.opacity:100;return op/100+'';//确保返回的是字符串
};}/* istanbul ignore next */avalon.fn.offset=function(){//取得距离页面左右角的坐标
var node=this[0],box={left:0,top:0};if(!node||!node.tagName||!node.ownerDocument){return box;}var doc=node.ownerDocument;var body=doc.body;var root$$1=doc.documentElement;var win=doc.defaultView||doc.parentWindow;if(!avalon.contains(root$$1,node)){return box;}//http://hkom.blog1.fc2.com/?mode=m&no=750 body的偏移量是不包含margin的
//我们可以通过getBoundingClientRect来获得元素相对于client的rect.
//http://msdn.microsoft.com/en-us/library/ms536433.aspx
if(node.getBoundingClientRect){box=node.getBoundingClientRect();// BlackBerry 5, iOS 3 (original iPhone)
}//chrome/IE6: body.scrollTop, firefox/other: root.scrollTop
var clientTop=root$$1.clientTop||body.clientTop,clientLeft=root$$1.clientLeft||body.clientLeft,scrollTop=Math.max(win.pageYOffset||0,root$$1.scrollTop,body.scrollTop),scrollLeft=Math.max(win.pageXOffset||0,root$$1.scrollLeft,body.scrollLeft);// 把滚动距离加到left,top中去。
// IE一些版本中会自动为HTML元素加上2px的border，我们需要去掉它
// http://msdn.microsoft.com/en-us/library/ms533564(VS.85).aspx
return{top:box.top+scrollTop-clientTop,left:box.left+scrollLeft-clientLeft};};//生成avalon.fn.scrollLeft, avalon.fn.scrollTop方法
/* istanbul ignore next */avalon.each({scrollLeft:'pageXOffset',scrollTop:'pageYOffset'},function(method,prop){avalon.fn[method]=function(val){var node=this[0]||{};var win=getWindow(node);var root$$1=avalon.root;var top=method==='scrollTop';if(!arguments.length){return win?prop in win?win[prop]:root$$1[method]:node[method];}else{if(win){win.scrollTo(!top?val:avalon(win).scrollLeft(),top?val:avalon(win).scrollTop());}else{node[method]=val;}}};});describe('css',function(){it('test',function(){var $root=avalon(avalon.root);expect($root.position()).toEqual({top:0,left:0});expect($root.offsetParent()[0]).toBe(avalon.root);expect($root.css('color','red')).toBe($root);expect($root.css('color')).toMatch(/red|rgb\(255,\s*0,\s*0\)/);$root.css('color','');expect(avalon.root.style.color).toBe('');expect($root.offset()).toEqual({left:0,top:0});expect($root.css('opacity')).toBe('1');$root.css('opacity','0.5');expect($root.css('opacity')).toBe('0.5');expect($root.css('top')).toBe('0px');expect($root.css('left')).toBe('0px');});});//import './seed/langSpec'
});